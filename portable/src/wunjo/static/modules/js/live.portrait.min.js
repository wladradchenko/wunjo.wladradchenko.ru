class SendModuleDataLivePortrait{constructor(e){this.method=e,this.subMethod=e,this.moduleParameters={nameFile:generateUUID(),cropField:[],avatarCropField:[],retargetParameters:[],animationRegionCode:"all",animationRegion:getTranslationBabel("All")},this.sourceFile={nameFile:null,urlFile:null,formatFile:null,fileSizeBytes:null,naturalWidth:null,naturalHeight:null,offsetWidth:null,offsetHeight:null,startTime:null,endTime:null},this.avatarFile={nameFile:null,urlFile:null,formatFile:null,fileSizeBytes:null,naturalWidth:null,naturalHeight:null,offsetWidth:null,offsetHeight:null,startTime:null,endTime:null},this.updatableKeys=new Set(["moduleParameters.nameFile","moduleParameters.animationRegionCode","moduleParameters.animationRegion"])}clearSourceFile(){this.sourceFile={nameFile:null,urlFile:null,formatFile:null,fileSizeBytes:null,naturalWidth:null,naturalHeight:null,offsetWidth:null,offsetHeight:null,startTime:null,endTime:null},this.avatarFile={nameFile:null,urlFile:null,formatFile:null,fileSizeBytes:null,naturalWidth:null,naturalHeight:null,offsetWidth:null,offsetHeight:null,startTime:null,endTime:null}}updateData(e){if(this.updatableKeys&&this.updatableKeys instanceof Set){const n=(e,t,a="")=>{for(const r in t){var l=a?a+"."+r:r;this.updatableKeys.has(l)&&r in e?e[r]=t[r]:"object"==typeof t[r]&&null!==t[r]&&r in e&&n(e[r],t[r],l)}};n(this,e)}else console.warn("updateData: updatableKeys not defined, update cancelled.")}}const callbacks={fetchSendModuleDataCallback:fetchSendModuleDataLivePortraitAnimation,setClearCallback:function(){sendModuleData.clearSourceFile()},toggleModificationCallback:null,setMetaButtonCallback:setMetaButtonLivePortrait,setMotionButtonCallback:null,setParametersButtonCallback:setParametersButtonLivePortrait,setModuleImgButtonsCallback:setModuleImgButtons,setModuleVideoButtonsCallback:setModuleVideoButtons,setDefaultSendModuleData:SendModuleDataLivePortrait};let sendModuleData=new SendModuleDataLivePortrait(moduleName);const regionCodes={[getTranslationBabel("All")]:"all",[getTranslationBabel("Expression")]:"exp",[getTranslationBabel("Head pose")]:"head",[getTranslationBabel("Lip")]:"lip",[getTranslationBabel("Eyes")]:"eyes"};async function fetchSendModuleDataLivePortraitAnimation(){var e=function(){var e=regionCodes[sendModuleData.moduleParameters.animationRegion]||"all";sendModuleData.moduleParameters.animationRegionCode=e;let t=!1,a=!1;if(!Array.isArray(sendModuleData.moduleParameters.cropField))return console.log("Crop field is not array"),{tmpFileNameSrc:t,tmpFileNameDst:a,validMessage:getTranslationBabel("Wow! Seems like you didn’t pick a face in your content witch need to animate. Click on the «Find face» button and set box on person face, please!")};if(0===sendModuleData.moduleParameters.cropField.length)return console.log("Crop field of source file is empty"),{tmpFileNameSrc:t,tmpFileNameDst:a,validMessage:getTranslationBabel("Wow! Seems like you didn’t pick a face in your content witch need to animate. Click on the «Find face» button and set box on person face, please!")};if(!Array.isArray(sendModuleData.moduleParameters.avatarCropField))return console.log("Avatar crop field is not array"),{tmpFileNameSrc:t,tmpFileNameDst:a,validMessage:getTranslationBabel("Param Pam Pam! It seems like your avatar’s face is feeling a bit missed!  Give that «Set avatar» button a click and upload a face with some personality!")};if(0===sendModuleData.moduleParameters.avatarCropField.length)return console.log("Avatar crop field of source file is empty"),{tmpFileNameSrc:t,tmpFileNameDst:a,validMessage:getTranslationBabel("Param Pam Pam! It seems like your avatar’s face is feeling a bit missed!  Give that «Set avatar» button a click and upload a face with some personality!")};if(""===sendModuleData.moduleParameters.nameFile.trim()&&(sendModuleData.moduleParameters.nameFile=generateUUID()),"number"!=typeof sendModuleData.sourceFile.offsetWidth||isNaN(sendModuleData.sourceFile.offsetWidth))return console.log("Offset width is not a number or is empty"),{tmpFileNameSrc:t,tmpFileNameDst:a,validMessage:getTranslationBabel("Uh-oh! The width looks wonky. Double-check it’s a number and not empty. Maybe click on «Select object» or load another file.")};if("number"!=typeof sendModuleData.avatarFile.offsetHeight||isNaN(sendModuleData.avatarFile.offsetHeight))return console.log("Offset height is not a number or is empty"),{tmpFileNameSrc:t,tmpFileNameDst:a,validMessage:getTranslationBabel("Hmm... The height seems fishy. Verify it’s a number and not empty. Check it’s a number and not empty. Maybe click on «Select object» or load another file.")};if(["jpg","jpeg","png","gif","bmp"].includes(sendModuleData.sourceFile.formatFile.toLowerCase()))t=generateImageFilename();else{if(!["mp4","avi","mov","wmv","mkv"].includes(sendModuleData.sourceFile.formatFile.toLowerCase()))return console.log("The format file is neither an image nor a video format."),{tmpFileNameSrc:t,tmpFileNameDst:a,validMessage:getTranslationBabel("Yikes! Looks like an alien format. Stick to images or videos for now.")};t=generateVideoFilename()}if(["jpg","jpeg","png","gif","bmp"].includes(sendModuleData.avatarFile.formatFile.toLowerCase()))a=generateImageFilename();else{if(!["mp4","avi","mov","wmv","mkv"].includes(sendModuleData.avatarFile.formatFile.toLowerCase()))return console.log("The format file is neither an image nor a video format."),{tmpFileNameSrc:t,tmpFileNameDst:a,validMessage:getTranslationBabel("Yikes! Looks like an alien format. Stick to images or videos for now.")};a=generateVideoFilename()}return{tmpFileNameSrc:t,tmpFileNameDst:a,validMessage:""}}(),t=e.tmpFileNameSrc,a=e.tmpFileNameDst,e=e.validMessage;return t&&a&&sendModuleData.sourceFile.urlFile&&(sendModuleData.sourceFile.nameFile=sendModuleData.sourceFile.urlFile.split("/").pop(),sendModuleData.avatarFile.urlFile)?(sendModuleData.avatarFile.nameFile=sendModuleData.avatarFile.urlFile.split("/").pop(),await createConnection(async function(){console.log(JSON.stringify(sendModuleData,null,4)),await postModuleTaskEvent(sendModuleData),sendModuleData.moduleParameters.nameFile=generateUUID()}),{statusBool:!0,validMessage:e}):{statusBool:!1,validMessage:e}}function setMetaButtonLivePortrait(){var e=document.querySelector(".footer-parameters").querySelector("div"),t=(e.innerHTML="",sendModuleData.moduleParameters.nameFile),t=createGeneralTextInput({label:getTranslationBabel("Filename"),defaultValue:t,disableStatus:!1,onChange:e=>{var t=event.target.value;/^[a-zA-Z0-9-]*$/.test(t)||(event.target.value=t.slice(0,-1)),sendModuleData.moduleParameters.nameFile=e}})["wrapper"];const l=createGeneralTextInput({label:getTranslationBabel("Resized to"),defaultValue:"1280x720",disableStatus:!0})["wrapper"];getLimitResolution(moduleName).then(e=>{var t=sendModuleData.sourceFile.naturalWidth,a=sendModuleData.sourceFile.naturalHeight,e=setLimitResolution(e,t,a);l.querySelector("input").value=e.newWidth+"x"+e.newHeight}).catch(e=>{}),e.append(t,l)}function setParametersButtonLivePortrait(){var e=document.querySelector(".footer-parameters").querySelector("div"),t=(e.innerHTML="",sendModuleData.moduleParameters.animationRegion),t=createGeneralSelectInput({label:getTranslationBabel("Animate"),dataDict:regionCodes,minChars:0,defaultValue:t,onChange:e=>{sendModuleData.moduleParameters.animationRegion=e}})["wrapper"];e.appendChild(t)}function setModuleImgButtons(){var e=[],t=setButtonSelectSourceLivePortrait(),a=setButtonSelectDestinationLivePortraitAnimate(),l=setButtonSelectLivePortraitManuallyRetargeting(),r=setButtonSelectAnalysis();return e.push(t,a,l,r),e}function setModuleVideoButtons(){var e=[],t=setButtonSelectSourceLivePortrait(),a=setButtonSelectDestinationLivePortraitAnimate(),l=setButtonSelectLivePortraitManuallyRetargeting(),r=setButtonSelectAnalysis();return e.push(t,a,l,r),e}function setButtonSelectSourceLivePortrait(){var e=document.createElement("div"),t=(e.classList.add("relative","group"),document.createElement("div")),a=(t.classList.add("hidden","absolute","p-2","group-hover:flex","items-center","gap-3","bottom-full","left-1/2","-translate-x-1/2","-translate-y-3.5","bg-dark-elements-hover","rounded-md","w-[300px]"),document.createElement("img")),l=(a.classList.add("w-20","h-20","rounded-md"),a.src="/static/modules/thumbnail/find_face.png",a.alt="Source face area select explain",a.width=256,a.height=256,document.createElement("span")),r=(l.classList.add("text-m-mobile","lg:text-m"),l.style="display: inline-block; vertical-align: top; text-decoration: inherit; text-wrap: balance;",l.textContent=getTranslationBabel("Pick face to live. Select start and end for seamless changes. No cutting, just smooth transitions. Easy!"),document.createElement("div")),n=(r.classList.add("module-button-div","relative","flex","gap-2","items-center","rounded-md","bg-light-emphasis"),r.style.stroke="white",document.createElement("button")),i=(n.classList.add("stroke-danger-primary","text-danger-primary","relative","flex","gap-2","items-center","group","py-1.5","pl-2","whitespace-nowrap","font-extra-thick","pr-2"),n.type="button",n.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="transition-[stroke,opacity] opacity-60 group-hover:opacity-100"><path d="M8 3H7.8C6.11984 3 5.27976 3 4.63803 3.32698C4.07354 3.6146 3.6146 4.07354 3.32698 4.63803C3 5.27976 3 6.11984 3 7.8V8M8 21H7.8C6.11984 21 5.27976 21 4.63803 20.673C4.07354 20.3854 3.6146 19.9265 3.32698 19.362C3 18.7202 3 17.8802 3 16.2V16M21 8V7.8C21 6.11984 21 5.27976 20.673 4.63803C20.3854 4.07354 19.9265 3.6146 19.362 3.32698C18.7202 3 17.8802 3 16.2 3H16M21 16V16.2C21 17.8802 21 18.7202 20.673 19.362C20.3854 19.9265 19.9265 20.3854 19.362 20.673C18.7202 21 17.8802 21 16.2 21H16M7.5 8V9.5M16.5 8V9.5M11 12.6001C11.8 12.6001 12.5 11.9001 12.5 11.1001V8M15.2002 15.2C13.4002 17 10.5002 17 8.7002 15.2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',document.createElement("span"));return i.textContent=getTranslationBabel("Find face"),n.onclick=function(){var e=document.querySelector(".footer-preview");e&&("img"===e.tagName.toLowerCase()&&e.src?createModalDetectImage(sendModuleData.sourceFile.urlFile,this,null):"video"===e.tagName.toLowerCase()&&e.src&&createModalDetectVideo(sendModuleData.sourceFile.urlFile,this,null))},n.appendChild(i),t.appendChild(a),t.appendChild(l),r.appendChild(n),e.appendChild(t),e.appendChild(r),e}function setButtonSelectDestinationLivePortraitAnimate(){var e=document.createElement("div"),t=(e.classList.add("relative","group"),document.createElement("div")),a=(t.classList.add("hidden","absolute","p-2","group-hover:flex","items-center","gap-3","bottom-full","left-1/2","-translate-x-1/2","-translate-y-3.5","bg-dark-elements-hover","rounded-md","w-[300px]"),document.createElement("img")),l=(a.classList.add("w-20","h-20","rounded-md"),a.src="/static/modules/thumbnail/upload_avatar.png",a.alt="Upload avatar face explain",a.width=256,a.height=256,document.createElement("span")),r=(l.classList.add("text-m-mobile","lg:text-m"),l.style="display: inline-block; vertical-align: top; text-decoration: inherit; text-wrap: balance;",l.textContent=getTranslationBabel("Upload avatar video to repeat movement. You’re a sculptor of non-existent personas. Done!"),document.createElement("div")),n=(r.classList.add("module-button-div","relative","flex","gap-2","items-center","rounded-md","bg-light-emphasis"),document.createElement("button")),i=(n.classList.add("stroke-danger-primary","text-danger-primary","relative","flex","gap-2","items-center","group","py-1.5","pl-2","whitespace-nowrap","font-extra-thick","pr-2"),n.type="button",n.innerHTML='<i class="fa-solid fa-arrows-down-to-people transition-[stroke,opacity] opacity-60 group-hover:opacity-100"></i>',document.createElement("span"));return i.textContent=getTranslationBabel("Upload avatar"),n.onclick=function(){document.querySelector(".footer-preview")&&createModalDetectAvatarVideo(this,null)},n.appendChild(i),t.appendChild(a),t.appendChild(l),r.appendChild(n),e.appendChild(t),e.appendChild(r),e}function setButtonSelectLivePortraitManuallyRetargeting(){var e=document.createElement("div"),t=(e.classList.add("relative","group"),document.createElement("div")),a=(t.classList.add("hidden","absolute","p-2","group-hover:flex","items-center","gap-3","bottom-full","left-1/2","-translate-x-1/2","-translate-y-3.5","bg-dark-elements-hover","rounded-md","w-[300px]"),document.createElement("img")),l=(a.classList.add("w-20","h-20","rounded-md"),a.src="/static/modules/thumbnail/manually_retargeting.png",a.alt="Retargeting explain",a.width=256,a.height=256,document.createElement("span")),r=(l.classList.add("text-m-mobile","lg:text-m"),l.style="display: inline-block; vertical-align: top; text-decoration: inherit; text-wrap: balance;",l.textContent=getTranslationBabel("Ready to manually retargeting face? Feel like a real puppeteer. Let’s go!"),document.createElement("div")),n=(r.classList.add("module-button-div","relative","flex","gap-2","items-center","rounded-md","bg-light-emphasis"),document.createElement("button")),i=(n.classList.add("relative","flex","gap-2","items-center","group","py-1.5","pl-2","whitespace-nowrap","font-extra-thick","pr-2"),n.type="button",n.innerHTML='<svg class="fa-solid fa-arrows-down-to-people transition-[stroke,opacity] opacity-60 group-hover:opacity-100" fill="white" height="20px" width="20px" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 422 422" xml:space="preserve" stroke="white" stroke-width="8.440000000000001"><g stroke-width="0"></g><g stroke-linecap="round" stroke-linejoin="round"></g><g> <g> <path d="M401.768,129.995H292.239c-0.128,0-0.233-0.104-0.233-0.233V20.233C292.006,9.076,282.929,0,271.773,0H150.228 c-11.156,0-20.233,9.076-20.233,20.233v109.529c0,0.128-0.104,0.233-0.233,0.233H20.233C9.077,129.995,0,139.071,0,150.228v121.545 c0,11.156,9.077,20.233,20.233,20.233h109.529c0.128,0,0.233,0.104,0.233,0.233v109.529c0,11.156,9.077,20.233,20.233,20.233 h121.545c11.156,0,20.233-9.076,20.233-20.233V292.238c0-0.128,0.104-0.233,0.233-0.233h109.529 c11.156,0,20.232-9.076,20.232-20.233V150.228C422,139.071,412.924,129.995,401.768,129.995z M402,271.773 c0,0.128-0.104,0.233-0.232,0.233H292.239c-11.156,0-20.233,9.076-20.233,20.233v109.529c0,0.128-0.104,0.233-0.233,0.233H150.228 c-0.128,0-0.233-0.104-0.233-0.233V292.238c0-11.156-9.077-20.233-20.233-20.233H20.233c-0.128,0-0.233-0.104-0.233-0.233V150.228 c0-0.128,0.104-0.233,0.233-0.233h109.529c11.156,0,20.233-9.076,20.233-20.233V20.233c0-0.128,0.104-0.233,0.233-0.233h121.545 c0.128,0,0.233,0.104,0.233,0.233v109.529c0,11.156,9.077,20.233,20.233,20.233h109.529c0.128,0,0.232,0.104,0.232,0.233V271.773z"></path> <path d="M186.875,99.857h48.25c3.573,0,6.874-1.906,8.66-5c1.787-3.094,1.787-6.906,0-10L219.66,43.072 c-1.786-3.094-5.087-5-8.66-5s-6.874,1.906-8.66,5l-24.125,41.785c-1.787,3.094-1.787,6.906,0,10 C180.001,97.951,183.303,99.857,186.875,99.857z M211,68.072l6.804,11.785h-13.608L211,68.072z"></path> <path d="M235.125,322.143h-48.25c-3.573,0-6.874,1.906-8.66,5c-1.787,3.094-1.787,6.906,0,10l24.125,41.785 c1.786,3.094,5.087,5,8.66,5c3.572,0,6.874-1.906,8.66-5l24.125-41.785c1.787-3.094,1.787-6.906,0-10 C241.999,324.049,238.698,322.143,235.125,322.143z M211,353.928l-6.804-11.785h13.608L211,353.928z"></path> <path d="M378.929,202.34l-41.785-24.124c-3.094-1.787-6.906-1.787-10,0c-3.094,1.786-5,5.087-5,8.66v48.249 c0,3.573,1.906,6.874,5,8.66c1.547,0.893,3.273,1.34,5,1.34s3.453-0.447,5-1.34l41.785-24.125c3.094-1.786,5-5.088,5-8.66 C383.929,207.427,382.022,204.126,378.929,202.34z M342.144,217.804v-13.608L353.929,211L342.144,217.804z"></path> <path d="M94.857,178.215c-3.094-1.786-6.905-1.786-10,0L43.072,202.34c-3.094,1.786-5,5.088-5,8.66c0,3.573,1.906,6.874,5,8.66 l41.785,24.125c1.547,0.893,3.273,1.34,5,1.34s3.453-0.447,5-1.34c3.094-1.786,5-5.087,5-8.66v-48.249 C99.857,183.303,97.951,180.001,94.857,178.215z M79.857,217.804L68.072,211l11.785-6.804V217.804z"></path> <path d="M212,166.264c-25.222,0-45.741,20.52-45.741,45.741s20.519,45.741,45.741,45.741s45.741-20.519,45.741-45.741 S237.222,166.264,212,166.264z M212,237.747c-14.193,0-25.741-11.547-25.741-25.741c0-14.194,11.547-25.741,25.741-25.741 c14.194,0,25.741,11.547,25.741,25.741C237.741,226.199,226.194,237.747,212,237.747z"></path></g></g></svg>',document.createElement("span"));return i.textContent=getTranslationBabel("Manually retargeting"),n.onclick=function(){var e=document.querySelector(".footer-preview");e&&("img"===e.tagName.toLowerCase()&&e.src?createModalManuallyRetargeting([{file:sendModuleData.sourceFile.urlFile,frame:1}]):"video"===e.tagName.toLowerCase()&&e.src&&createModalSceneDetect(sendModuleData.sourceFile.urlFile,sendModuleData.sourceFile.formatFile,sendModuleData.moduleParameters.intervalGeneration))},n.appendChild(i),t.appendChild(a),t.appendChild(l),r.appendChild(n),e.appendChild(t),e.appendChild(r),e}function setButtonSelectAnalysis(){var e=document.createElement("div"),t=(e.classList.add("relative","group"),document.createElement("div")),a=(t.classList.add("hidden","absolute","p-2","group-hover:flex","items-center","gap-3","bottom-full","left-1/2","-translate-x-1/2","-translate-y-3.5","bg-dark-elements-hover","rounded-md","w-[300px]"),document.createElement("img")),l=(a.classList.add("w-20","h-20","rounded-md"),a.src="/static/modules/thumbnail/analyser.png",a.alt="Fake detector",a.width=256,a.height=256,document.createElement("span")),r=(l.classList.add("text-m-mobile","lg:text-m"),l.style="display: inline-block; vertical-align: top; text-decoration: inherit; text-wrap: balance;",l.textContent=getTranslationBabel("Got a sneaky suspicion about some content? Ready to sniff out those deepfakes? Just hit that button."),document.createElement("div")),n=(r.classList.add("module-button-div","relative","flex","gap-2","items-center","rounded-md","bg-light-emphasis"),document.createElement("button")),i=(n.classList.add("relative","flex","gap-2","items-center","group","py-1.5","pl-2","whitespace-nowrap","font-extra-thick","pr-2"),n.type="button",n.innerHTML='<svg width="20px" height="20px" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fill="white" class="w-4 h-4 transition-[stroke,opacity] opacity-60 group-hover:opacity-100"><path d="M1.5 1a.5.5 0 0 0-.5.5v3a.5.5 0 0 1-1 0v-3A1.5 1.5 0 0 1 1.5 0h3a.5.5 0 0 1 0 1h-3zM11 .5a.5.5 0 0 1 .5-.5h3A1.5 1.5 0 0 1 16 1.5v3a.5.5 0 0 1-1 0v-3a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 1-.5-.5zM.5 11a.5.5 0 0 1 .5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 1 0 1h-3A1.5 1.5 0 0 1 0 14.5v-3a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v3a1.5 1.5 0 0 1-1.5 1.5h-3a.5.5 0 0 1 0-1h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 1 .5-.5zM3 4.5a.5.5 0 0 1 1 0v7a.5.5 0 0 1-1 0v-7zm2 0a.5.5 0 0 1 1 0v7a.5.5 0 0 1-1 0v-7zm2 0a.5.5 0 0 1 1 0v7a.5.5 0 0 1-1 0v-7zm2 0a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-7zm3 0a.5.5 0 0 1 1 0v7a.5.5 0 0 1-1 0v-7z"/></svg>',document.createElement("span"));return i.textContent=getTranslationBabel("Analysis"),n.onclick=function(){document.querySelector(".footer-preview")&&createModalLoadAnalysis(sendModuleData.sourceFile.urlFile,sendModuleData.sourceFile.formatFile)},n.appendChild(i),t.appendChild(a),t.appendChild(l),r.appendChild(n),e.appendChild(t),e.appendChild(r),e}async function createModalSceneDetect(a,l=null,e){"ontouchstart"in window||navigator.msMaxTouchPoints;var t=document.querySelector(".modal-load-scenedetect-template").content.cloneNode(!0);const r=t.querySelector(".modal-root"),n=r.querySelector(".modal-message"),i=r.querySelector(".threshold"),o=r.querySelector(".interval");var s=r.querySelector(".scenedetect-button");const d=s.parentElement.parentElement;observeAttributeChange(o,"value",function(e){u(getTranslationBabel("Scene transitions with frames interval")+` ${e} `+getTranslationBabel("and the first and last frame will be received."),"default"),d.classList.remove("hidden")});const c=async()=>{let e;e=(["jpg","jpeg","png","gif","bmp"].includes(l.toLowerCase())?generateImageFilename:["mp4","avi","mov","wmv","mkv"].includes(l.toLowerCase())?generateVideoFilename:["wav","mp3"].includes(l.toLowerCase())?generateAudioFilename:generateUUID)(),"string"==typeof a&&(a=await urlToBlob(a)),uploadChunkFile(a,e);var t={method:moduleScenedetectName,filename:e,interval:i.getAttribute("value"),threshold:o.getAttribute("value")};await fetch("/submit-cpu-task",{method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{if(200===e.status){const t=e.id;setTimeout(()=>{(async e=>{const a=setInterval(async()=>{await fetch(`/query-cpu-task/${e}`,{method:"GET",headers:{"Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{if(e.status===200){clearInterval(a);if(!e.response){u(getTranslationBabel("Oops! Something went wrong. Please try again."),"error");return}const t=e.response.scenes;if(Array.isArray(t)&&t.length!==0){createModalManuallyRetargeting(t);r.remove()}else u(getTranslationBabel("Wow! Somthing went wrong. Because of scenes can not be empty. Please try another file."),"error")}else if(e.status===300){clearInterval(a);u(e.response.message,"default")}else if(e.status===404){clearInterval(a);u(e.response.message,"error")}}).catch(e=>{console.error("An error occurred:",error);clearInterval(a);u(getTranslationBabel("Oops! An unexpected error occurred. Please try again."),"error")})},3e3)})(t)},1e3)}else loaderModalWarn("Something wrong..."+e.message)}).catch(e=>{loaderModalError("Something wrong...During create task.")})};function u(e,t="default"){d.classList.add("hidden"),n.setAttribute("status",t),n.setAttribute("value",e)}s.onclick=async function(){d.innerHTML="";var e=document.createElement("div"),t=(e.classList.add("flex","items-center","gap-2","p-2.5","relative","w-full","h-10","bg-dark-elements","rounded-[.625rem]","overflow-hidden"),document.createElement("div")),a=(t.classList.add("absolute","w-full","h-full","left-0","top-0","bg-gradient-to-r","from-[rgba(255,237,210,0.20)]","to-accent-primary","opacity-10"),t.style.background="linear-gradient(to right, rgba(255, 237, 210, 0.2), rgb(255, 237, 210))",document.createElement("p"));a.classList.add("text-m-mobile","md:text-m","grow"),a.textContent=getTranslationBabel("Scanning..."),(scanLoadingDivBackground=document.createElement("div")).classList.add("absolute","h-full","w-full","left-0","top-0","animate-loadingStripe"),scanLoadingDivBackground.style.background="repeating-linear-gradient(-45deg, rgba(255, 255, 255, 0), rgba(255, 255, 255, 0) 16px, rgba(0, 0, 0, 0.08) 16px, rgba(0, 0, 0, 0.08) 32px) 0% 0% / 200% 200%",e.appendChild(t),e.innerHTML+='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" fill="none" class="animate-loadingRing mx-auto stroke-accent-primary"><path d="M17.5 10C17.5 14.1421 14.1421 17.5 10 17.5C5.85786 17.5 2.5 14.1421 2.5 10C2.5 5.85786 5.85786 2.5 10 2.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>',e.appendChild(a),e.appendChild(scanLoadingDivBackground),d.appendChild(e),await c()},console.log(a),document.body.appendChild(t)}async function createGenerationParametersManuallyRetargeting(d,M,e=null,t=null,z=null,a=null){var N="ontouchstart"in window||navigator.msMaxTouchPoints;const c=document.querySelector(".modal-retargeting-parameters-template").content.cloneNode(!0).querySelector(".modal-root"),l=c.querySelector(".modal-canvas"),I=c.querySelector(".modal-load-element");I.setAttribute("data-index",d);var W=c.querySelector(".number-frames"),R=c.querySelector(".download");const r=c.querySelector(".modal-submit-btn"),n=c.querySelector(".modal-back-btn");var j=c.querySelector(".delete-button");const i=c.querySelector(".view-button"),o=c.querySelectorAll(".modal-eye-ratio"),s=c.querySelectorAll(".modal-eye-ratio-slider"),u=c.querySelectorAll(".modal-lip-ratio"),V=c.querySelectorAll(".modal-lip-ratio-slider"),m=c.querySelectorAll(".modal-pitch"),O=c.querySelectorAll(".modal-pitch-slider"),h=c.querySelectorAll(".modal-yaw"),Y=c.querySelectorAll(".modal-yaw-slider"),p=c.querySelectorAll(".modal-roll"),X=c.querySelectorAll(".modal-roll-slider"),f=c.querySelectorAll(".modal-eyeball-direction-x"),U=c.querySelectorAll(".modal-eyeball-direction-x-slider"),g=c.querySelectorAll(".modal-eyeball-direction-y"),G=c.querySelectorAll(".modal-eyeball-direction-y-slider"),y=c.querySelectorAll(".modal-x"),J=c.querySelectorAll(".modal-x-slider"),v=c.querySelectorAll(".modal-y"),Z=c.querySelectorAll(".modal-y-slider"),b=c.querySelectorAll(".modal-z"),$=c.querySelectorAll(".modal-z-slider"),S=c.querySelectorAll(".modal-smile"),K=c.querySelectorAll(".modal-smile-slider"),x=c.querySelectorAll(".modal-wink"),_=c.querySelectorAll(".modal-wink-slider"),w=c.querySelectorAll(".modal-eyebrow"),Q=c.querySelectorAll(".modal-eyebrow-slider"),F=c.querySelectorAll(".modal-grin"),ee=c.querySelectorAll(".modal-grin-slider"),E=c.querySelectorAll(".modal-pursing"),te=c.querySelectorAll(".modal-pursing-slider"),C=c.querySelectorAll(".modal-pouting"),ae=c.querySelectorAll(".modal-pouting-slider"),k=c.querySelectorAll(".modal-lip-expression"),le=c.querySelectorAll(".modal-lip-expression-slider"),q=c.querySelector(".quick-input");let L={};var re=new Zooming;function ne(e,t,a,l){return void 0===e||void 0===t?{scaleX:1,scaleY:1}:(scaleX=a/e,scaleY=l/t,{scaleX:scaleX,scaleY:scaleY})}function ie(r,a){a.forEach(e=>{var t=createFaceDetectCrop(r,l,a,function(e,t,a,l){r.setAttribute("data-face",JSON.stringify({x:e,y:t,width:a-e,height:l-t})),q.disabled=!1});!function e(t,a){var l=t.style.transform,r=t.style.transition;a.style.transform=l,a.style.transition=r,requestAnimationFrame(()=>e(t,a))}(r,t),t.classList.add("bboxes","absolute","w-full","h-full","object-contain","z-[1]"),c.querySelectorAll(".bboxes").forEach(e=>e.remove()),l.appendChild(t)}),loaderModalHidden(d)}if(0===M?(r.classList.add("hidden"),n.classList.add("hidden"),q.classList.add("hidden")):new MutationObserver(e=>{e.forEach(e=>{"attributes"!==e.type||"class"!==e.attributeName||c.classList.contains("hidden")||((e=c.querySelector("img")).src=e.src)})}).observe(c,{attributes:!0}),e&&e instanceof HTMLImageElement){const A=e.cloneNode(!0);A.classList.add("w-auto","max-w-full","object-contain","h-full"),A.setAttribute("default-src",A.src),a?A.setAttribute("data-index",a):A.setAttribute("data-index",d),A.onload=async()=>{var e=L.cropField||[{}],t=ne(L.naturalWidth,L.naturalHeight,A.naturalWidth,A.naturalHeight);1===t.scaleX&&1===t.scaleY||(e[0].x=Math.ceil(e[0].x*t.scaleX)||null,e[0].y=Math.ceil(e[0].y*t.scaleY)||null,e[0].width=Math.ceil(e[0].width*t.scaleX)||null,e[0].height=Math.ceil(e[0].height*t.scaleY)||null),L.cropField=[{x:e[0].x,y:e[0].y,width:e[0].width,height:e[0].height}];try{await detectFacesTool(A,e=>{e&&0!==e.length||(L.cropField=[{}]),ie(A,e)})}catch(e){console.error("Failed to detect faces:",e)}L.naturalWidth=A.naturalWidth,L.naturalHeight=A.naturalHeight,L.offsetWidth=A.offsetWidth,L.offsetHeight=A.offsetHeight},l.appendChild(A),handleZoomClick(A),re.listen(A)}else{if(!t||!z)return null;if(!["jpg","jpeg","png","gif","bmp"].includes(z.toLowerCase()))return console.log("The format file is neither an image format."),null;{const T=new Image;T.src=t,T.setAttribute("default-src",t),a?T.setAttribute("data-index",a):T.setAttribute("data-index",d),T.classList.add("w-auto","max-w-full","object-contain","h-full"),T.onload=async()=>{var e=L.cropField||[{}],t=ne(L.naturalWidth,L.naturalHeight,T.naturalWidth,T.naturalHeight);1===t.scaleX&&1===t.scaleY||(e[0].x=Math.ceil(e[0].x*t.scaleX)||null,e[0].y=Math.ceil(e[0].y*t.scaleY)||null,e[0].width=Math.ceil(e[0].width*t.scaleX)||null,e[0].height=Math.ceil(e[0].height*t.scaleY)||null),L.cropField=[{x:e[0].x,y:e[0].y,width:e[0].width,height:e[0].height}];try{await detectFacesTool(T,e=>{e&&0!==e.length||(L.cropField=[{}]),ie(T,e)})}catch(e){console.error("Failed to detect faces:",e)}L.naturalWidth=T.naturalWidth,L.naturalHeight=T.naturalHeight,L.offsetWidth=T.offsetWidth,L.offsetHeight=T.offsetHeight},l.appendChild(T),handleZoomClick(T),re.listen(T)}}W.textContent=d+1+" / "+(M+1);const oe=function(t,a){let l;return function(...e){clearTimeout(l),l=setTimeout(()=>t.apply(this,e),a)}}(async function(){loaderModalBusy(getTranslationBabel("Retargeting... Buttons are locked until finished. Tap on the screen to view details."),d),I.classList.remove("hidden");var e=c.querySelector("img");if(e){if(L.sourceImg=e.getAttribute("default-src"),!e.getAttribute("data-face"))return void loaderModalHidden(d);L.cropField=[JSON.parse(e.getAttribute("data-face"))],L.naturalWidth=e.naturalWidth,L.naturalHeight=e.naturalHeight,L.offsetWidth=e.offsetWidth,L.offsetHeight=e.offsetHeight}L.eyeRatio=o[0].value,L.lipRatio=u[0].value,L.pitch=m[0].value,L.yaw=h[0].value,L.roll=p[0].value,L.eyeballX=f[0].value,L.eyeballY=g[0].value,L.headX=y[0].value,L.headY=v[0].value,L.headZ=b[0].value,L.smile=S[0].value,L.wink=x[0].value,L.eyebrow=w[0].value,L.grin=F[0].value,L.pursing=E[0].value,L.pouting=C[0].value,L.lipExpression=k[0].value,de(!0);e={...L};sendModuleData.moduleParameters.retargetParameters.splice(d,1),sendModuleData.moduleParameters.retargetParameters.push(e),await fetchSendModuleDataRetargetPortrait(d,ce)},500);function se(e,t,a){const l=Math.max(Math.min(a.value,a.max),a.min),r=Math.ceil((l-a.min)/(a.max-a.min)*100);e.forEach(e=>{e.value=l,e.style.setProperty("--fill-size",r+"%"),e.addEventListener("input",oe)}),t.forEach(e=>{e.value=l,e.addEventListener("input",oe)})}function D(t,a){t.forEach(e=>{e.addEventListener("change",function(){se(a,t,this)})}),a.forEach(e=>{e.addEventListener("input",function(){se(a,t,this)})})}function de(t=!0){n.disabled=t,r.disabled=t,o.forEach(e=>{e.disabled=t}),s.forEach(e=>{e.disabled=t}),u.forEach(e=>{e.disabled=t}),V.forEach(e=>{e.disabled=t}),m.forEach(e=>{e.disabled=t}),O.forEach(e=>{e.disabled=t}),h.forEach(e=>{e.disabled=t}),Y.forEach(e=>{e.disabled=t}),p.forEach(e=>{e.disabled=t}),X.forEach(e=>{e.disabled=t}),f.forEach(e=>{e.disabled=t}),U.forEach(e=>{e.disabled=t}),g.forEach(e=>{e.disabled=t}),G.forEach(e=>{e.disabled=t}),y.forEach(e=>{e.disabled=t}),J.forEach(e=>{e.disabled=t}),v.forEach(e=>{e.disabled=t}),Z.forEach(e=>{e.disabled=t}),b.forEach(e=>{e.disabled=t}),$.forEach(e=>{e.disabled=t}),S.forEach(e=>{e.disabled=t}),K.forEach(e=>{e.disabled=t}),x.forEach(e=>{e.disabled=t}),_.forEach(e=>{e.disabled=t}),w.forEach(e=>{e.disabled=t}),Q.forEach(e=>{e.disabled=t}),F.forEach(e=>{e.disabled=t}),ee.forEach(e=>{e.disabled=t}),E.forEach(e=>{e.disabled=t}),te.forEach(e=>{e.disabled=t}),C.forEach(e=>{e.disabled=t}),ae.forEach(e=>{e.disabled=t}),k.forEach(e=>{e.disabled=t}),le.forEach(e=>{e.disabled=t})}function ce(e=null,t=!1,a){de(t),e&&(c.querySelector("img").src=e)}function ue(){i.classList.contains("bg-dark-elements")&&(i.classList.add("hover:bg-accent-hover","text-dark-background","bg-accent-primary"),i.classList.remove("hover:bg-dark-elements-hover","text-light-primary","bg-dark-elements","!bg-dark-pop-up"),i.innerHTML='<i style="width: 20px; height: 18px; margin-top: .125rem;" class="fa-regular fa-eye"></i>')}async function me(e,t=null,a=0,l=1,r=1){var n=document.querySelector(".modal-effect-template").content.cloneNode(!0),i=n.querySelector(".modal-root"),o=i.querySelector("h2"),s=i.querySelector(".threshold-title"),o=(o.textContent=e,s.textContent+=" "+e.toLowerCase(),i.querySelector(".frequency-button"));const d=i.querySelector(".smooth-checkpoint"),c=i.querySelector(".frequency-input"),u=i.querySelector(".frequency-slider");s=i.querySelector(".frequency-slider-max");const m=i.querySelector(".threshold-input-max"),h=i.querySelector(".threshold-input-min"),p=i.querySelector(".threshold-slider-max"),f=i.querySelector(".threshold-slider-min");var e=i.querySelector(".threshold-slider-text-max"),g=i.querySelector(".threshold-slider-text-min");i.querySelector(".slider-double-range");c.max=M,u.max=M,s.textContent=M,h.min=a,h.max=l,h.value=a/2,h.step=r,m.min=a,m.max=l,m.value=l/2,m.step=r,e.textContent=l,g.textContent=a,c.addEventListener("change",function(){var e=Math.ceil((this.value-this.min)/(this.max-this.min)*100);u.value=this.value,u.style.setProperty("--fill-size",e+"%")}),u.addEventListener("input",function(){var e=Math.ceil((this.value-this.min)/(this.max-this.min)*100);c.value=this.value,this.style.setProperty("--fill-size",e+"%")}),initializeDoubleSlider(i,a,l,r),p.value=l/2,p.addEventListener("input",()=>{m.value=p.value}),f.value=a/2,f.addEventListener("input",()=>{h.value=f.value}),o.onclick=async function(){t&&"function"==typeof t&&await t(c.value,f.value,p.value,d.checked),closeModal(this)},document.body.appendChild(n)}async function P(t={}){var a=document.querySelector(".modal-root-parameters").childNodes,l=c.querySelector("img"),r=l.getAttribute("data-face")?[JSON.parse(l.getAttribute("data-face"))]:[{}];sendModuleData.moduleParameters.retargetParameters.splice(d,1);for(let e=d;e<M+1;e++){var n,i,o={},s=a[e].querySelector("img");o.dataIndex=s.getAttribute("data-index"),o.naturalWidth=l.naturalWidth,o.naturalHeight=l.naturalHeight,o.offsetWidth=l.offsetWidth,o.offsetHeight=l.offsetHeight;for([n,i]of Object.entries(t))o[n]=i[e-d];s={cropField:r,...o};sendModuleData.moduleParameters.retargetParameters.push(s)}de(!0),loaderModalBusy("Data preparation 0%",d),await fetchSendModuleDataRetargetPortraitCompleted(),document.querySelector(".modal-retarget-close-button").click()}function he(a,e,l){var t,r;return a<0&&e<0&&a<e?[...t=Array.from({length:Math.floor((e-a)/l)+1},(e,t)=>a+t*l),...t.reverse().slice(1)]:a<0&&0<e?(t=Array.from({length:Math.floor((0-a)/l)+1},(e,t)=>a+t*l),[...r=Array.from({length:Math.floor(+e/l)+1},(e,t)=>0+t*l),...[...r].reverse().slice(1),...[...t].reverse().slice(1),...t]):0<=a&&0<=e&&a<e?[...r=Array.from({length:Math.floor((e-a)/l)+1},(e,t)=>a+t*l),...r.reverse().slice(1)]:[0]}async function pe(){(async function(e,t){var a=document.querySelector(".modal-effect-template").content.cloneNode(!0),l=a.querySelector(".modal-root"),r=l.querySelector("h2"),n=l.querySelector(".threshold-title"),r=(r.textContent=e,n.textContent+=" "+e.toLowerCase(),l.querySelector(".frequency-button")),e=(n=l.querySelector(".frequency-wrapper")).cloneNode(!0),i=n.cloneNode(!0);const o=n.querySelector(".frequency-input"),s=n.querySelector(".frequency-slider");var d=n.querySelector(".frequency-slider-max");o.max=M,s.max=M,d.textContent=M;const c=e.querySelector(".frequency-input"),u=(d=e.querySelector(".frequency-text"),e.querySelector(".frequency-slider"));var m=e.querySelector(".frequency-slider-min"),h=e.querySelector(".frequency-slider-max");d.textContent="Eyeball X",c.max=30,u.max=30,h.textContent=30,m.textContent=-30,c.min=-30,u.min=-30,c.value=0,u.value=0,u.style.setProperty("--fill-size","50%");const p=i.querySelector(".frequency-input"),f=(d=i.querySelector(".frequency-text"),i.querySelector(".frequency-slider")),g=(h=i.querySelector(".frequency-slider-min"),m=i.querySelector(".frequency-slider-max"),d.textContent="Eyeball Y",p.max=60,f.max=60,m.textContent=60,h.textContent=-60,p.min=-60,f.min=-60,p.value=0,f.value=0,f.style.setProperty("--fill-size","50%"),l.querySelector(".smooth-wrapper").remove(),(d=l.querySelector(".threshold-wrapper")).querySelector(".threshold-input-max")),y=d.querySelector(".threshold-input-min"),v=d.querySelector(".threshold-slider-max"),b=d.querySelector(".threshold-slider-min");m=d.querySelector(".threshold-slider-text-max"),h=d.querySelector(".threshold-slider-text-min"),d=d.querySelector(".slider-double-range"),b.value=-.3,b.style.left="31.25%",v.value=0,v.style.left="50%",d.style="left: 31.25%; width: 18.75%;",y.min=-.8,y.max=.8,y.value=-.3,y.step=.05,g.min=-.8,g.max=.8,g.value=0,g.step=.05,m.textContent=.8,h.textContent=-.8,n.parentElement.insertBefore(i,n.nextSibling),n.parentElement.insertBefore(e,n.nextSibling),o.addEventListener("change",function(){var e=Math.ceil((this.value-this.min)/(this.max-this.min)*100);s.value=this.value,s.style.setProperty("--fill-size",e+"%")}),s.addEventListener("input",function(){var e=Math.ceil((this.value-this.min)/(this.max-this.min)*100);o.value=this.value,this.style.setProperty("--fill-size",e+"%")}),c.addEventListener("change",function(){var e=Math.ceil((this.value-this.min)/(this.max-this.min)*100);u.value=this.value,u.style.setProperty("--fill-size",e+"%")}),u.addEventListener("input",function(){var e=Math.ceil((this.value-this.min)/(this.max-this.min)*100);c.value=this.value,this.style.setProperty("--fill-size",e+"%")}),p.addEventListener("change",function(){var e=Math.ceil((this.value-this.min)/(this.max-this.min)*100);f.value=this.value,f.style.setProperty("--fill-size",e+"%")}),f.addEventListener("input",function(){var e=Math.ceil((this.value-this.min)/(this.max-this.min)*100);p.value=this.value,this.style.setProperty("--fill-size",e+"%")}),initializeDoubleSlider(l,-.8,.8,.05),v.addEventListener("input",()=>{g.value=v.value}),b.addEventListener("input",()=>{y.value=b.value}),r.onclick=async function(){t&&"function"==typeof t&&await t(o.value,b.value,v.value,c.value,p.value),closeModal(this)},document.body.appendChild(a)})("Blinking",async function(e=1,t=-.8,a=0,l=0,r=0){t=parseFloat(t),a=parseFloat(a),l=parseInt(l,10),r=parseInt(r,10),e=parseInt(e,10);const n=[...Array(e).fill(a),t];P({eyeRatio:[...Array(M-d).fill(0)].map((e,t)=>n[t%n.length]),eyeballX:Array(M-d).fill(l),eyeballY:Array(M-d).fill(r)})})}async function fe(){await me("Nodding",async function(e=1,t=-90,a=90,l=!1){t=parseInt(t,10),a=parseInt(a,10),e=parseInt(e,10);const r=[...Array(e).fill(0),t,...Array(e).fill(0),a];var n=[...Array(M-d).fill(0)].map((e,t)=>r[t%r.length]);const i=he(t,a,Math.round((a-t)/(2*e)));a=[...Array(M-d)].map((e,t)=>i[t%i.length]),P({yaw:l?a:n})},-90,90,1)}async function ge(){await me("Shaking",async function(e=1,t=-90,a=90,l=!1){t=parseInt(t,10),a=parseInt(a,10),e=parseInt(e,10);const r=[...Array(e).fill(0),t,...Array(e).fill(0),a];var n=[...Array(M-d).fill(0)].map((e,t)=>r[t%r.length]);const i=he(t,a,Math.round((a-t)/(2*e)));a=[...Array(M-d)].map((e,t)=>i[t%i.length]),P({pitch:l?a:n})},-90,90,1)}async function ye(){await me("Flirt",async function(e=1,t=-30,a=30,l=!1){t=parseInt(t,10),a=parseInt(a,10),e=parseInt(e,10);const r=[...Array(e).fill(0),t,...Array(e).fill(0),a];var n=[...Array(M-d).fill(0)].map((e,t)=>r[t%r.length]);const i=he(t,a,Math.round((a-t)/(2*e)));a=[...Array(M-d)].map((e,t)=>i[t%i.length]),P({eyebrow:l?a:n})},-30,30,1)}if(D(o,s),D(u,V),D(m,O),D(h,Y),D(p,X),D(f,U),D(g,G),D(y,J),D(v,Z),D(b,$),D(S,K),D(x,_),D(w,Q),D(F,ee),D(E,te),D(C,ae),D(k,le),j.onclick=function(){var e,t=c.querySelector("img");t&&(e=t.getAttribute("default-src"))&&(t.src=e),o.forEach(e=>{e.value=0}),s.forEach(e=>{e.value=0,e.style.setProperty("--fill-size",Math.ceil((0-e.min)/(e.max-e.min)*100)+"%")}),u.forEach(e=>{e.value=0}),V.forEach(e=>{e.value=0,e.style.setProperty("--fill-size",Math.ceil((0-e.min)/(e.max-e.min)*100)+"%")}),m.forEach(e=>{e.value=0}),O.forEach(e=>{e.value=0,e.style.setProperty("--fill-size",Math.ceil((0-e.min)/(e.max-e.min)*100)+"%")}),h.forEach(e=>{e.value=0}),Y.forEach(e=>{e.value=0,e.style.setProperty("--fill-size",Math.ceil((0-e.min)/(e.max-e.min)*100)+"%")}),p.forEach(e=>{e.value=0}),X.forEach(e=>{e.value=0,e.style.setProperty("--fill-size",Math.ceil((0-e.min)/(e.max-e.min)*100)+"%")}),f.forEach(e=>{e.value=0}),U.forEach(e=>{e.value=0,e.style.setProperty("--fill-size",Math.ceil((0-e.min)/(e.max-e.min)*100)+"%")}),g.forEach(e=>{e.value=0}),G.forEach(e=>{e.value=0,e.style.setProperty("--fill-size",Math.ceil((0-e.min)/(e.max-e.min)*100)+"%")}),y.forEach(e=>{e.value=0}),J.forEach(e=>{e.value=0,e.style.setProperty("--fill-size",Math.ceil((0-e.min)/(e.max-e.min)*100)+"%")}),v.forEach(e=>{e.value=0}),Z.forEach(e=>{e.value=0,e.style.setProperty("--fill-size",Math.ceil((0-e.min)/(e.max-e.min)*100)+"%")}),b.forEach(e=>{e.value=1}),$.forEach(e=>{e.value=1,e.style.setProperty("--fill-size",Math.ceil((1-e.min)/(e.max-e.min)*100)+"%")}),S.forEach(e=>{e.value=0}),K.forEach(e=>{e.value=0,e.style.setProperty("--fill-size",Math.ceil((0-e.min)/(e.max-e.min)*100)+"%")}),x.forEach(e=>{e.value=0}),_.forEach(e=>{e.value=0,e.style.setProperty("--fill-size",Math.ceil((0-e.min)/(e.max-e.min)*100)+"%")}),w.forEach(e=>{e.value=0}),Q.forEach(e=>{e.value=0,e.style.setProperty("--fill-size",Math.ceil((0-e.min)/(e.max-e.min)*100)+"%")}),F.forEach(e=>{e.value=0}),ee.forEach(e=>{e.value=0,e.style.setProperty("--fill-size",Math.ceil((0-e.min)/(e.max-e.min)*100)+"%")}),E.forEach(e=>{e.value=0}),te.forEach(e=>{e.value=0,e.style.setProperty("--fill-size",Math.ceil((0-e.min)/(e.max-e.min)*100)+"%")}),C.forEach(e=>{e.value=0}),ae.forEach(e=>{e.value=0,e.style.setProperty("--fill-size",Math.ceil((0-e.min)/(e.max-e.min)*100)+"%")}),k.forEach(e=>{e.value=0}),le.forEach(e=>{e.value=0,e.style.setProperty("--fill-size",Math.ceil((0-e.min)/(e.max-e.min)*100)+"%")})},0===d&&(n.disabled=!0),R.onclick=function(){var e,t=c.querySelector("img");t&&(t=t.src,(e=document.createElement("a")).href=t,e.download=generateImageFilename(),document.body.appendChild(e),e.click(),document.body.removeChild(e))},i.onclick=function(){var e=c.querySelectorAll(".bboxes");this.classList.contains("bg-dark-elements")?(this.classList.add("hover:bg-accent-hover","text-dark-background","bg-accent-primary"),this.classList.remove("hover:bg-dark-elements-hover","text-light-primary","bg-dark-elements","!bg-dark-pop-up"),this.innerHTML='<i style="width: 20px; height: 18px; margin-top: .125rem;" class="fa-regular fa-eye"></i>',e.forEach(e=>e.classList.remove("hidden"))):(this.classList.add("hover:bg-dark-elements-hover","text-light-primary","bg-dark-elements","!bg-dark-pop-up"),this.classList.remove("hover:bg-accent-hover","text-dark-background","bg-accent-primary"),this.innerHTML='<i style="width: 20px; height: 18px; margin-top: .125rem;" class="fa-regular fa-eye-slash"></i>',e.forEach(e=>e.classList.add("hidden")))},n.onclick=function(){var e=document.querySelector(".modal-root-parameters").childNodes,t=d-1;(0<t||0==t)&&(sendModuleData.moduleParameters.retargetParameters.splice(d,1),e[t].classList.remove("hidden"),c.classList.add("hidden")),ue()},d===M&&"Continue"===r.textContent.trim()&&(r.textContent="Submit"),r.onclick=async function(){var e=document.querySelector(".modal-root-parameters").childNodes,t=d+1,a=c.querySelector("img"),a=(a&&(L.sourceImg=a.getAttribute("default-src"),L.naturalWidth=a.naturalWidth,L.naturalHeight=a.naturalHeight,L.offsetWidth=a.offsetWidth,L.offsetHeight=a.offsetHeight),L.dataIndex=a.getAttribute("data-index"),L.eyeRatio=o[0].value,L.lipRatio=u[0].value,L.pitch=m[0].value,L.yaw=h[0].value,L.roll=p[0].value,L.eyeballX=f[0].value,L.eyeballY=g[0].value,L.headX=y[0].value,L.headY=v[0].value,L.headZ=b[0].value,L.smile=S[0].value,L.wink=x[0].value,L.eyebrow=w[0].value,L.grin=F[0].value,L.pursing=E[0].value,L.pouting=C[0].value,L.lipExpression=k[0].value,a.getAttribute("data-face")?[JSON.parse(a.getAttribute("data-face"))]:[{}]),a={cropField:a,...L};sendModuleData.moduleParameters.retargetParameters.splice(d,1),sendModuleData.moduleParameters.retargetParameters.push(a),e.length>t?(e[t].querySelector("img"),e[t].classList.remove("hidden"),c.classList.add("hidden")):(await fetchSendModuleDataRetargetPortraitCompleted(),document.querySelector(".modal-retarget-close-button").click()),ue()},0!==M){const B={[getTranslationBabel("Blinking")]:pe,[getTranslationBabel("Silent")]:async function(){P({lipRatio:Array(M-d).fill(-.8),lipExpression:Array(M-d).fill(-45)})},[getTranslationBabel("Nodding")]:fe,[getTranslationBabel("Shaking")]:ge,[getTranslationBabel("Flirt")]:ye};e=Object.keys(B);const H=new Awesomplete(q,{list:e,minChars:0,maxItems:N?3:10});q.addEventListener("focus",function(){q.value="",H.evaluate(),H.open()}),H.ul.style.maxHeight="10rem",H.ul.style.maxWidth="20px",H.ul.style.overflowX="hidden",q.addEventListener("awesomplete-selectcomplete",async function(e){e.text.value in B&&B[e.text.value]()})}else q.parentElement.classList.add("hidden");return c}async function createModalManuallyRetargeting(r){var e=document.querySelector(".modal-retargeting-submit-template").content.cloneNode(!0);const n=e.querySelector(".modal-root").querySelector(".modal-root-parameters");sendModuleData.moduleParameters.retargetParameters=[],r.forEach(async(e,t)=>{var a,l=e.file,e=e.frame;l&&(a=1<(a=(a=l).split(".")).length?a.pop():"",(l=await createGenerationParametersManuallyRetargeting(t,r.length-1,null,l,a,e))instanceof HTMLDivElement)&&(0!==t&&l.classList.add("hidden"),n.appendChild(l))}),document.body.appendChild(e)}async function fetchSendModuleDataRetargetPortrait(r,n=null){(async()=>{var e=sendModuleData.moduleParameters.retargetParameters[r];let t=e.sourceImg;var a=generateImageFilename();"string"==typeof t&&(t=await urlToBlob(t)),uploadChunkFile(t,a),e.sourceImg=null;const l={method:moduleRetargetName,filename:a,retargetParameters:e};console.log(JSON.stringify(l,null,4)),await fetch("/submit-cpu-task",{method:"POST",body:JSON.stringify(l),headers:{"Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{if(200===e.status){const t=e.id;setTimeout(()=>{(async(a,e,l=null)=>{const r=setInterval(async()=>{await fetch(`/query-cpu-task/${e}`,{method:"GET",headers:{"Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{if(e.status===200){clearInterval(r);if(!e.response){loaderModalWarn(getTranslationBabel("Oops! Something went wrong. Please click submit again after some time. Tap on the screen to view details."),a);if(l&&typeof l==="function")l(null,true);return}const t=e.response.filename;if(l&&typeof l==="function")l(t);loaderModalHidden(a)}else if(e.status===300){loaderModalWarn(e.response.message,a);if(l&&typeof l==="function")l(null,true,true)}else if(e.status===404){loaderModalWarn(e.response.message,a);if(l&&typeof l==="function")l(null,true,true)}else loaderModalBusy(`${e.progress_message} ${e.progress}%`,a)}).catch(e=>{clearInterval(r);loaderModalError(getTranslationBabel("Oops! An unexpected error occurred. Tap on the screen to view details."),a);if(l&&typeof l==="function")l(null,true,true)})},3e3)})(r,t,n)},1e3)}else loaderModalWarn("Something wrong..."+e.message,r)}).catch(e=>{loaderModalError("Something wrong...During create task. Tap on the screen to view details.",r)})})()}async function fetchSendModuleDataRetargetPortraitCompleted(){sendModuleData.sourceFile.urlFile;if(sendModuleData.sourceFile.urlFile){sendModuleData.sourceFile.nameFile=sendModuleData.sourceFile.urlFile.split("/").pop();var e=sendModuleData.sourceFile.formatFile;if(["mp4","avi","mov","wmv","mkv"].includes(e.toLowerCase())||["jpg","jpeg","png","gif","bmp"].includes(e.toLowerCase())){var t=sendModuleData.moduleParameters.retargetParameters;t.forEach(e=>{e.sourceImg=null});const a={method:moduleName,subMethod:moduleRetargetName,sourceFile:{nameFile:sendModuleData.sourceFile.nameFile,formatFile:e,naturalWidth:sendModuleData.sourceFile.naturalWidth,naturalHeight:sendModuleData.sourceFile.naturalHeight,offsetWidth:sendModuleData.sourceFile.offsetWidth,offsetHeight:sendModuleData.sourceFile.offsetHeight,startTime:sendModuleData.sourceFile.startTime,endTime:sendModuleData.sourceFile.endTime},moduleParameters:{nameFile:sendModuleData.moduleParameters.nameFile,retargetParameters:t}};await createConnection(async function(){console.log(JSON.stringify(a,null,4)),await postModuleTaskEvent(a),sendModuleData.moduleParameters.nameFile=generateUUID()})}else updateMessage(getTranslationBabel("Yikes! Looks like an alien format. Stick to videos or image for now."))}else updateMessage(getTranslationBabel("Something wrong."))}function setLiteSetting(){const e=getTranslationBabel("live portrait");var t=document.querySelector("#settings");t.href="",t.onclick=async function(){event.preventDefault(),createModalLiteSetting(e,"LIVE_PORTRAIT")}}setLiteSetting(),createFooterFile(callbacks,pageFileFormats);