class SendModuleDataRestyling{constructor(e){this.method=e,this.subMethod=e,this.moduleParameters={nameFile:generateUUID(),intervalGeneration:20,threshold:47,controlStrength:.7,sdModel:initDefaultSdModel(),SAM:[],DiffusionParametersSAM:[],ControlDiffusionParameters:[]},this.sourceFile={nameFile:null,urlFile:null,formatFile:null,fileSizeBytes:null,naturalWidth:null,naturalHeight:null,offsetWidth:null,offsetHeight:null,startTime:null,endTime:null},this.updatableKeys=new Set(["moduleParameters.nameFile","moduleParameters.intervalGeneration","moduleParameters.threshold","moduleParameters.controlStrength","moduleParameters.sdModel"])}clearSourceFile(){this.sourceFile={nameFile:null,urlFile:null,formatFile:null,fileSizeBytes:null,naturalWidth:null,naturalHeight:null,offsetWidth:null,offsetHeight:null,startTime:null,endTime:null}}updateData(e){if(this.updatableKeys&&this.updatableKeys instanceof Set){const l=(e,t,a="")=>{for(const o in t){var n=a?a+"."+o:o;this.updatableKeys.has(n)&&o in e?e[o]=t[o]:"object"==typeof t[o]&&null!==t[o]&&o in e&&l(e[o],t[o],n)}};l(this,e)}else console.warn("updateData: updatableKeys not defined, update cancelled.")}}const callbacks={fetchSendModuleDataCallback:openModalRestylingSubmit,setClearCallback:function(){sendModuleData.clearSourceFile()},toggleModificationCallback:toggleModificationRestyling,setMetaButtonCallback:setMetaButtonRestyling,setMotionButtonCallback:setMotionButtonRestyling,setParametersButtonCallback:setParametersButtonRestyling,setModuleImgButtonsCallback:setModuleImgButtons,setModuleVideoButtonsCallback:setModuleVideoButtons,setDefaultSendModuleData:SendModuleDataRestyling};let sendModuleData=new SendModuleDataRestyling(moduleName),useBackgroundRestyle=!1,newBrashImg=[];function initDefaultSdModel(){for(const e of sdModels)if(e.hasOwnProperty("model"))return e.model;return null}function getRandomPrompt(){var e=[getTranslationBabel("A stuffed animal donkey grazing in a valley"),getTranslationBabel("Cinematic, sunny day, waves crashing on the shore of a beach"),getTranslationBabel("A cow grazing in a valley during the day, a UFO approaches in the distance"),getTranslationBabel("A flower blooming in slow motion"),getTranslationBabel("3D render, a raccoon holding a mini ice cream cone"),getTranslationBabel("POV of a car driving in outer space traveling through time, time travel tunnel"),getTranslationBabel("2 cats in love eating a candlelit dinner of fresh fish"),getTranslationBabel("Cinematic, a dog in a car window"),getTranslationBabel("Moody, filmic, 35mm, a doctor walking into the hospital"),getTranslationBabel("POV of a car driving in outer space traveling through time, time travel tunnel"),getTranslationBabel("3D render, goldfish swimming in a glass container"),getTranslationBabel("Nature documentary, jellyfish swimming in the ocean"),getTranslationBabel("Cinematic, a Tibetan monk sitting in a temple on a mountain, facing camera."),getTranslationBabel("Nature documentary, natural lighting, flamingo walking in a beautiful beach, head turning"),getTranslationBabel("Low angle dolly in shot, a wild west town with saloons and dusty streets"),getTranslationBabel("A secret garden with a rainbow waterfall"),getTranslationBabel("Cinematic, a cowboy riding a horse on mirror-like lake, moving clouds"),getTranslationBabel("Cinematic, long tracking shot of the cliffs of Dover"),getTranslationBabel("1950s film style, a seagull on a boat"),getTranslationBabel("Cinematic, sunny day, waves crashing on the shore of a beach"),getTranslationBabel("A woman smiling while watching fireworks"),getTranslationBabel("Beautiful sunset at the beach, silhouette of a couple walking by the seashore against sunset, beautiful scenery"),getTranslationBabel("Low angle dolly in shot, a wild west town with saloons and dusty streets"),getTranslationBabel("Anime, a boy and a girl sitting on the grass under the starry sky"),getTranslationBabel("Nature documentary, close up of a lizard in a desert"),getTranslationBabel("1940s newsreel footage, a soldier stands watch on a rocky hill, facing camera"),getTranslationBabel("Anime, a woman walking home with groceries, wide angle"),getTranslationBabel("Watercolor style of a baby elephant drinking water from a lake in the desert"),getTranslationBabel("Futuristic film of a man walking on a street in Paris, cinematic, symmetric composition"),getTranslationBabel("Claymation, stop motion, a rat sitting on a huge block of cheese")];return e[Math.floor(Math.random()*e.length)]}async function openModalRestylingSubmit(){async function a(a,t,e=null,n=null,o=null){const l=document.querySelector(".modal-restyle-parameters-template").content.cloneNode(!0).querySelector(".modal-root");var r=l.querySelector(".modal-canvas");const i=l.querySelector(".modal-positive-prompt"),s=l.querySelector(".modal-negative-prompt");var d=l.querySelector(".inspire-button"),c=l.querySelectorAll(".modal-submit-btn"),u=l.querySelector(".modal-back-btn");const m=l.querySelectorAll(".modal-seed"),h=l.querySelectorAll(".modal-strength");var g=l.querySelectorAll(".modal-strength-slider");const p=l.querySelectorAll(".modal-scale");var f=l.querySelectorAll(".modal-scale-slider");const v=Math.floor(1000001*Math.random());if(m.forEach(e=>{e.value=v}),e&&e instanceof HTMLImageElement){e=e.cloneNode(!0);e.classList.add("w-auto","h-full","max-w-full","object-contain"),r.appendChild(e)}else{if(!n||!o)return null;if(["jpg","jpeg","png","gif","bmp"].includes(o.toLowerCase())){e=new Image;e.src=n,e.classList.add("w-auto","h-full","max-w-full","object-contain"),r.appendChild(e)}else{if(!["mp4","avi","mov","wmv","mkv"].includes(o.toLowerCase()))return console.log("The format file is neither an image nor a video format."),null;e=document.createElement("video");e.src=n,e.muted=!0,e.autoplay=!0,e.loop=!0,e.classList.add("w-auto","h-full","max-w-full","object-contain"),r.appendChild(e)}}let y={seed:"",strength:.75,scale:7.5,positivePrompt:"",negativePrompt:""};function b(e,t,a){const n=Math.max(Math.min(a.value,a.max),a.min),o=Math.ceil((n-a.min)/(a.max-a.min)*100);e.forEach(e=>{e.value=n,e.style.setProperty("--fill-size",o+"%")}),t.forEach(e=>{e.value=n})}function w(t,a){t.forEach(e=>{e.addEventListener("change",function(){b(a,t,this)})}),a.forEach(e=>{e.addEventListener("input",function(){b(a,t,this)})})}return m.forEach(e=>{e.addEventListener("change",function(e){const t=e.target.value;m.forEach(e=>{e.value=t})})}),w(h,g),w(p,f),d.onclick=function(){i.value=getRandomPrompt()},0===a&&(u.disabled=!0),u.onclick=function(){var e=document.querySelector(".modal-root-parameters").childNodes,t=a-1;(0<t||0==t)&&(sendModuleData.moduleParameters.DiffusionParametersSAM.splice(a,1),e[t].classList.remove("hidden"),l.classList.add("hidden"))},c.forEach(e=>{a===t&&"Continue"===e.textContent.trim()&&(e.textContent="Submit"),e.onclick=async function(){var e=document.querySelector(".modal-root-parameters").childNodes,t=a+1;y.positivePrompt=i.value,y.negativePrompt=s.value,y.seed=m[0].value,y.strength=h[0].value,y.scale=p[0].value,0<i.value.length?(sendModuleData.moduleParameters.DiffusionParametersSAM.splice(a,1),sendModuleData.moduleParameters.DiffusionParametersSAM.push(y),e.length>t?(e[t].classList.remove("hidden"),l.classList.add("hidden")):(await fetchSendModuleDataRestyling(),document.querySelector(".modal-restyle-close-button").click())):console.log("Positive prompt is empty")}}),l}if(Array.isArray(newBrashImg)&&0!==newBrashImg.length&&Array.isArray(sendModuleData.moduleParameters.SAM)&&0!==sendModuleData.moduleParameters.SAM.length||useBackgroundRestyle){sendModuleData.moduleParameters.DiffusionParametersSAM=[];var e,t=document.querySelector(".modal-restyle-submit-template").content.cloneNode(!0);const n=t.querySelector(".modal-root").querySelector(".modal-root-parameters");return useBackgroundRestyle?(sendModuleData.sourceFile.urlFile,e=sendModuleData.sourceFile.formatFile,(e=await a(0,0,null,sendModuleData.sourceFile.urlFile,e))instanceof HTMLDivElement&&n.appendChild(e)):newBrashImg.forEach(async(e,t)=>{e&&(e=await a(t,newBrashImg.length-1,e))instanceof HTMLDivElement&&(0!==t&&e.classList.add("hidden"),n.appendChild(e))}),document.body.appendChild(t),{statusBool:!0,validMessage:""}}return{statusBool:!1,validMessage:getTranslationBabel("Looks like you forgot to pick an object to restyle, or hey, why not go all out and change everything? Give it another shot!")}}async function fetchSendModuleDataRestyling(){var e=function(){if(Array.isArray(sendModuleData.moduleParameters.DiffusionParametersSAM)&&0!==sendModuleData.moduleParameters.DiffusionParametersSAM.length){let n=[];if(useBackgroundRestyle){var e=sendModuleData.moduleParameters.DiffusionParametersSAM[0];n.push({background:e})}else{e=sendModuleData.moduleParameters.SAM.filter(e=>null!=e&&""!==e);if(0===e)return{tmpFileName:!1,validMessage:getTranslationBabel("Uh-oh! This is strange magic, but the object is not selected. Try selecting objects again.")};e.forEach((e,t)=>{var a;e&&"object"==typeof sendModuleData.moduleParameters.DiffusionParametersSAM[t]&&(a=sendModuleData.moduleParameters.DiffusionParametersSAM[t],n.push({[t]:{...a,pointList:e}}),console.log(n))})}if(sendModuleData.moduleParameters.DiffusionParametersSAM=n,""===sendModuleData.moduleParameters.nameFile.trim()&&(sendModuleData.moduleParameters.nameFile=generateUUID()),!1===useBackgroundRestyle){if("number"!=typeof sendModuleData.sourceFile.offsetWidth||isNaN(sendModuleData.sourceFile.offsetWidth))return console.log("Offset width is not a number or is empty"),{tmpFileName:!1,validMessage:getTranslationBabel("Uh-oh! The width looks wonky. Double-check it’s a number and not empty. Maybe click on «Select object» or load another file.")};if("number"!=typeof sendModuleData.sourceFile.offsetHeight||isNaN(sendModuleData.sourceFile.offsetHeight))return console.log("Offset height is not a number or is empty"),{tmpFileName:!1,validMessage:getTranslationBabel("Hmm... The height seems fishy. Verify it’s a number and not empty. Check it’s a number and not empty. Maybe click on «Select object» or load another file.")}}else sendModuleData.sourceFile.offsetWidth=sendModuleData.sourceFile.naturalWidth,sendModuleData.sourceFile.offsetHeight=sendModuleData.sourceFile.naturalHeight;return["jpg","jpeg","png","gif","bmp"].includes(sendModuleData.sourceFile.formatFile.toLowerCase())?{tmpFileName:generateImageFilename(),validMessage:""}:["mp4","avi","mov","wmv","mkv"].includes(sendModuleData.sourceFile.formatFile.toLowerCase())?{tmpFileName:generateVideoFilename(),validMessage:""}:(console.log("The format file is neither an image nor a video format."),{tmpFileName:!1,validMessage:getTranslationBabel("Yikes! Looks like an alien format. Stick to images or videos for now.")})}return console.error("Diffusion Parameters SAM is empty."),{tmpFileName:!1,validMessage:getTranslationBabel("Diffusion parameters is empty.")}}(),t=e.tmpFileName,e=e.validMessage;if(t){if(!sendModuleData.sourceFile.urlFile)return{statusBool:!1,validMessage:e};sendModuleData.sourceFile.nameFile=sendModuleData.sourceFile.urlFile.split("/").pop();for(const n of sendModuleData.moduleParameters.DiffusionParametersSAM)for(const o of Object.keys(n)){var a=n[o];a.negativePrompt&&(a.negativePrompt=await translateText(a.negativePrompt,"en","auto")),a.positivePrompt&&(a.positivePrompt=await translateText(a.positivePrompt,"en","auto"))}await createConnection(async function(){console.log(JSON.stringify(sendModuleData,null,4)),await postModuleTaskEvent(sendModuleData),sendModuleData.moduleParameters.nameFile=generateUUID(),sendModuleData.moduleParameters.DiffusionParametersSAM=[]})}else t=e,(e=document.querySelector(".footer-notification"))&&e instanceof HTMLParagraphElement&&(e.textContent=t,e.classList.remove("hidden"))}async function fetchSendModuleDataControlRestyling(){var t=document.querySelector(".modal-root-parameters").querySelectorAll("img"),a=generateVideoFilename(),n=sendModuleData.sourceFile.urlFile,o=sendModuleData.moduleParameters.nameFile,l=sendModuleData.sourceFile.formatFile;if(["mp4","avi","mov","wmv","mkv"].includes(l.toLowerCase())){const r={method:moduleName,subMethod:moduleControlName,sourceFile:{nameFile:a,formatFile:l},moduleParameters:{nameFile:o,layerFiles:[]}};let e=n;(e="string"==typeof e?await urlToBlob(e):e)?(console.log("download file"),await uploadChunkFile(e,a),t.forEach(async e=>{var t=e.getAttribute("data-index");let a=e.src;var e=generateImageFilename(),n={};n[t]=e,r.moduleParameters.layerFiles.push(n),(a="string"==typeof a?await urlToBlob(a):a)?(console.log("download file"),await uploadChunkFile(a,e)):updateMessage(getTranslationBabel("Oops. Something wrong... Try another layer file."))}),await createConnection(async function(){console.log(JSON.stringify(r,null,4)),await postModuleTaskEvent(r)})):updateMessage(getTranslationBabel("Oops. Something wrong... Try another file."))}else updateMessage(getTranslationBabel("Yikes! Looks like an alien format. Stick to videos for now."))}function toggleModificationRestyling(e){var t=e.querySelector(".footer-toggle-icon"),a=e.querySelector(".footer-toggle-name"),n=e.querySelector(".footer-toggle-title"),e=e.querySelector(".sr-only");t.innerHTML='<svg width="22px" height="22px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M15 7.49996L17.5 9.99996M7.5 20L19.25 8.24996C19.9404 7.5596 19.9404 6.44032 19.25 5.74996V5.74996C18.5596 5.0596 17.4404 5.05961 16.75 5.74996L5 17.5V20H7.5ZM7.5 20H15.8787C17.0503 20 18 19.0502 18 17.8786V17.8786C18 17.316 17.7765 16.7765 17.3787 16.3786L17 16M4.5 4.99996C6.5 2.99996 10 3.99996 10 5.99996C10 8.5 4 8.5 4 11C4 11.8759 4.53314 12.5256 5.22583 13" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',a.textContent=getTranslationBabel("Restyle background"),n.textContent=getTranslationBabel("Activate the restyle background option to refresh the entire frame. This setting ensures that all elements are redrawn with the neural network, providing a seamless."),e.onchange=function(){toggleLogical(this),useBackgroundRestyle=!useBackgroundRestyle;var e=document.querySelector(".sam-button");e&&(!useBackgroundRestyle&&Array.isArray(sendModuleData.moduleParameters.SAM)?(e.classList.remove("stroke-danger-primary","text-danger-primary","stroke-accent-primary","text-accent-primary","stroke-light-primary","text-light-primary"),e.disabled=!1,0===sendModuleData.moduleParameters.SAM.length?e.classList.add("stroke-danger-primary","text-danger-primary"):e.classList.add("stroke-accent-primary","text-accent-primary")):(e.classList.remove("stroke-danger-primary","text-danger-primary","stroke-accent-primary","text-accent-primary"),e.classList.add("stroke-light-primary","text-light-primary"),e.disabled=!0))}}function setMetaButtonRestyling(){var e=document.querySelector(".footer-parameters").querySelector("div"),t=(e.innerHTML="",sendModuleData.moduleParameters.nameFile),t=createGeneralTextInput({label:getTranslationBabel("Filename"),defaultValue:t,disableStatus:!1,onChange:e=>{var t=event.target.value;/^[a-zA-Z0-9-]*$/.test(t)||(event.target.value=t.slice(0,-1)),sendModuleData.moduleParameters.nameFile=e}})["wrapper"];const n=createGeneralTextInput({label:getTranslationBabel("Resized to"),defaultValue:"1280x720",disableStatus:!0})["wrapper"];getLimitResolution(moduleName).then(e=>{var t=sendModuleData.sourceFile.naturalWidth,a=sendModuleData.sourceFile.naturalHeight,e=setLimitResolution(e,t,a);n.querySelector("input").value=e.newWidth+"x"+e.newHeight}).catch(e=>{}),e.append(t,n)}function setMotionButtonRestyling(){var e=document.querySelector(".footer-parameters").querySelector("div"),t=(e.innerHTML="",sendModuleData.moduleParameters.intervalGeneration),a=getTranslationBabel("Alright, listen up! The generation interval is like setting the tempo for your video’s style dance-off. Got a video with dynamic moves? Drop that value to crank up the tempo. It’s like your video’s heartbeat - more transitions mean a faster beat, so you’ll want a lower value. Nail that interval, and watch your video steal the spotlight in style!"),n=getTranslationBabel("Alright, listen up! The generation interval is like setting the tempo for your video’s style dance-off. Got a video with dynamic moves? Drop that value to crank up the tempo. It’s like your video’s heartbeat - more transitions mean a faster beat, so you’ll want a lower value. Nail that interval, and watch your video steal the spotlight in style!"),a=createGeneralSliderInput({label:getTranslationBabel("Interval generation"),min:5,max:40,step:1,titleMax:a,titleMin:n,defaultValue:t,onChange:e=>{sendModuleData.moduleParameters.intervalGeneration=e}})["wrapper"],n=sendModuleData.moduleParameters.threshold,t=getTranslationBabel("Alright, listen up! Increase threshold to do scene transition detection more accuracy. Nail that threshold, and watch your new scene transition!"),o=getTranslationBabel("Alright, listen up! Drop threshold to weaken scene transition detection. Nail that threshold, and watch your new scene transition!"),t=createGeneralSliderInput({label:getTranslationBabel("Threshold scene"),min:1,max:100,step:1,titleMax:t,titleMin:o,defaultValue:n,onChange:e=>{sendModuleData.moduleParameters.threshold=e}})["wrapper"];e.append(a,t)}function setParametersButtonRestyling(){var e=document.querySelector(".footer-parameters").querySelector("div"),t=(e.classList.remove("mt-3"),e.innerHTML="",sendModuleData.moduleParameters.controlStrength),a=getTranslationBabel("Increase control strength to up depend to frames."),n=getTranslationBabel("Reduce control strength to less depend to frames."),a=createGeneralSliderInput({label:getTranslationBabel("Control strength"),min:.1,max:1,step:.01,titleMax:a,titleMin:n,defaultValue:t,onChange:e=>{sendModuleData.moduleParameters.controlStrength=e}})["wrapper"],n=document.createElement("div"),t=(n.classList.add("flex","gap-3","items-center","justify-between"),document.createElement("p"));t.classList.add("font-extra-thick","underline","text-accent-primary","question","group"),t.innerHTML=`${getTranslationBabel("Style")}<div class="bg-dark-pop-up bg-opacity-50 backdrop-blur-2xl absolute bottom-full -translate-y-1 left-1/2 -translate-x-1/2 lg:text-s text-s-mobile px-1.5 py-1 rounded-md after:absolute after:top-full after:left-1/2 after:-translate-x-1/2 after:border-t-[5px] after:border-x-[3px] after:border-x-transparent after:border-t-dark-elements hidden hidden-on-touchscreen group-hover:block whitespace-nowrap">${getTranslationBabel("Add a new custom Stable Diffusion 1.5 model to the configuration file located at")} <code>./wunjo/all_models/custom_diffusion.json</code>.</div>`;const r=document.createElement("div");r.classList.add("grid-cols-2","gap-5","grid","overflow-auto"),r.style.maxHeight="6.9rem";let i=0;sdModels.forEach(e=>{if(e.hasOwnProperty("model")){var t=document.createElement("div");t.classList.add("group","flex","flex-col","justify-center","items-center","text-center");const l=document.createElement("button");l.classList.add("model-picker","w-[5.625rem]","h-[5.625rem]","rounded-md","opacity-60","group-hover:opacity-100","transition-all"),l.type="button";var a=document.createElement("p");a.classList.add("w-[5.625rem]"),a.style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis;",e.hasOwnProperty("name")?a.textContent=e.name:a.textContent=(n=e.model)?(o=n.lastIndexOf("."),n.substring(0,o).replace(/_/g," ").toLowerCase().replace(/^\w/,e=>e.toUpperCase())):"Unknown",sendModuleData.moduleParameters.sdModel?sendModuleData.moduleParameters.sdModel===e.model&&(l.classList.remove("opacity-60"),l.style.border="2px solid white"):0===i&&(l.classList.remove("opacity-60"),l.style.border="2px solid white",sendModuleData.moduleParameters.sdModel=e.model),e.hasOwnProperty("img")?l.style.backgroundImage=`url(${e.img})`:l.style.backgroundColor="#0d0d0d",l.style.backgroundSize="cover",l.style.backgroundPosition="center",l.onclick=function(){r.querySelectorAll(".model-picker").forEach(e=>{e.classList.add("opacity-60"),e.style.border=""}),this.classList.remove("opacity-60"),this.style.border="2px solid white";var e=l.getAttribute("model");sendModuleData.moduleParameters.sdModel=e},e.hasOwnProperty("url")&&(l.title=e.url),l.setAttribute("model",e.model),t.appendChild(l),t.appendChild(a),r.appendChild(t),i++}var n,o}),n.appendChild(t),e.append(a,n,r)}function setModuleImgButtons(){var e=[],t=setButtonSelectSourceSAM();return e.push(t),e}function setModuleVideoButtons(){var e=[],t=setButtonSelectSourceSAM(),a=setButtonControlRestyle();return e.push(t,a),e}function setButtonControlRestyle(){var e=document.createElement("div"),t=(e.classList.add("relative","group"),document.createElement("div")),a=(t.classList.add("hidden","absolute","p-2","group-hover:flex","items-center","gap-3","bottom-full","left-1/2","-translate-x-1/2","-translate-y-3.5","bg-dark-elements-hover","rounded-md","w-[300px]"),document.createElement("img")),n=(a.classList.add("w-20","h-20","rounded-md"),a.src="/static/modules/thumbnail/attach_sample.png",a.alt="Segment object",a.width=256,a.height=256,document.createElement("span")),o=(n.classList.add("text-m-mobile","lg:text-m"),n.style="display: inline-block; vertical-align: top; text-decoration: inherit; text-wrap: balance;",n.textContent=getTranslationBabel("Modify specific objects or entire scenes with simple text prompts. Experience advanced visual manipulation!"),document.createElement("div")),l=(o.classList.add("relative","flex","gap-2","items-center","rounded-md","bg-light-emphasis"),o.style.stroke="white",document.createElement("button")),r=(l.classList.add("text-light-primary","stroke-light-primary","relative","flex","gap-2","items-center","group","py-1.5","pl-2","whitespace-nowrap","font-extra-thick","pr-2"),l.type="button",l.innerHTML='<svg class="transition-[stroke,opacity] opacity-60 group-hover:opacity-100" width="20px" height="20px" fill="none" stroke="white" stroke-width="1.5px" viewBox="0 0 24 24"><path d="M17.13,22.5H9.87a2,2,0,1,1,0-4.05h1.86L5.06,11.78a2,2,0,0,1-.19-2.65A1.92,1.92,0,0,1,7.68,9l4.05,4.05L15.81,10a1.9,1.9,0,0,1,2.49.18h0a17.3,17.3,0,0,1,4.17,6.74l.06.19"></path><path d="M13,1.5H8.25A1.91,1.91,0,0,0,6.34,3.41h0A1.92,1.92,0,0,0,8.25,5.32h2.86A1.9,1.9,0,0,1,13,7.23h0a1.91,1.91,0,0,1-1.91,1.91H8.29"></path></svg>',document.createElement("span"));return r.textContent=getTranslationBabel("Control restyle"),l.onclick=function(){var e=document.querySelector(".footer-preview");!e||"img"===e.tagName.toLowerCase()&&e.src||"video"===e.tagName.toLowerCase()&&e.src&&createModalSceneDetect(sendModuleData.sourceFile.urlFile,sendModuleData.sourceFile.formatFile,sendModuleData.moduleParameters.intervalGeneration)},l.appendChild(r),t.appendChild(a),t.appendChild(n),o.appendChild(l),e.appendChild(t),e.appendChild(o),e}function setButtonSelectSourceSAM(){var e=document.createElement("div"),t=(e.classList.add("relative","group"),document.createElement("div")),a=(t.classList.add("hidden","absolute","p-2","group-hover:flex","items-center","gap-3","bottom-full","left-1/2","-translate-x-1/2","-translate-y-3.5","bg-dark-elements-hover","rounded-md","w-[300px]"),document.createElement("img")),n=(a.classList.add("w-20","h-20","rounded-md"),a.src="/static/modules/thumbnail/select_object.png",a.alt="Segment object",a.width=256,a.height=256,document.createElement("span")),o=(n.classList.add("text-m-mobile","lg:text-m"),n.style="display: inline-block; vertical-align: top; text-decoration: inherit; text-wrap: balance;",n.textContent=getTranslationBabel("Let the neural network handle it, then click to include with the right, exclude with the left. Don’t forget to switch brushes."),document.createElement("div")),l=(o.classList.add("relative","flex","gap-2","items-center","rounded-md","bg-light-emphasis"),o.style.stroke="white",document.createElement("button")),r=(l.classList.add("sam-button","text-danger-primary","stroke-danger-primary","relative","flex","gap-2","items-center","group","py-1.5","pl-2","whitespace-nowrap","font-extra-thick","pr-2"),l.type="button",l.innerHTML='<i class="fa-solid fa-object-group transition-[stroke,opacity] opacity-60 group-hover:opacity-100"></i>',document.createElement("span"));function i(e){var t=e.getContext("2d").getImageData(0,0,e.width,e.height).data;for(let e=0;e<t.length;e+=4)if(0!==t[e+3])return;return 1}function s(){newBrashImg=[];const e=document.querySelector("video.media-element"),t=(e.muted=!0,document.querySelectorAll(".canvas-brash"));if(t&&e){const r=document.createElement("canvas"),a=r.getContext("2d");e.addEventListener("seeked",async function(){r.width=e.videoWidth,r.height=e.videoHeight,a.drawImage(e,0,0),t.forEach(e=>{var t,a,n,o,l;i(e)||(t=e.classList,t="new-mask-"+Array.from(t).find(e=>e.startsWith("canvas-brash-")).replace("canvas-brash-",""),l=(a=document.createElement("canvas")).getContext("2d"),n=Math.max(r.width,e.width),o=Math.max(r.height,e.height),a.width=n,a.height=o,l.drawImage(r,0,0,n,o),l.drawImage(e,0,0,n,o),l=a.toDataURL("image/png"),(e=new Image).width=n,e.height=o,e.src=l,e.classList.add(t),newBrashImg.push(e))})}),e.currentTime=e.currentTime}}function d(){newBrashImg=[];var e=document.querySelector("img.media-element"),t=document.querySelectorAll(".canvas-brash");if(t&&e){const r=document.createElement("canvas");var a=r.getContext("2d");r.width=e.naturalWidth,r.height=e.naturalHeight,a.drawImage(e,0,0),t.forEach(e=>{var t,a,n,o,l;i(e)||(t=e.classList,t="new-mask-"+Array.from(t).find(e=>e.startsWith("canvas-brash-")).replace("canvas-brash-",""),l=(a=document.createElement("canvas")).getContext("2d"),n=Math.max(r.width,e.width),o=Math.max(r.height,e.height),console.log(o,n),a.width=n,a.height=o,l.drawImage(r,0,0,n,o),l.drawImage(e,0,0,n,o),l=a.toDataURL("image/png"),(e=new Image).width=n,e.height=o,e.src=l,e.classList.add(t),newBrashImg.push(e))})}}return r.textContent=getTranslationBabel("Select object"),useBackgroundRestyle&&(l.classList.remove("stroke-danger-primary","text-danger-primary","stroke-accent-primary","text-accent-primary"),l.classList.add("stroke-light-primary","text-light-primary"),l.disabled=!0),l.onclick=function(){var e=document.querySelector(".footer-preview");e&&("img"===e.tagName.toLowerCase()&&e.src?createModalSAMImage(sendModuleData.sourceFile.urlFile,this,d):"video"===e.tagName.toLowerCase()&&e.src&&createModalSAMVideo(sendModuleData.sourceFile.urlFile,this,s))},l.appendChild(r),t.appendChild(a),t.appendChild(n),o.appendChild(l),e.appendChild(t),e.appendChild(o),e}async function createModalSceneDetect(a,n=null,e=null){"ontouchstart"in window||navigator.msMaxTouchPoints;var t=document.querySelector(".modal-load-scenedetect-template").content.cloneNode(!0);const o=t.querySelector(".modal-root"),l=o.querySelector(".modal-message");var r=o.querySelector(".scenedetect-button");const i=r.parentElement.parentElement;function s(e){parametersThresholdInputValDefault=e,parametersThresholdInput.value=e,parametersThresholdSliderInput.value=e;e=Math.ceil((e-parametersThresholdSliderInput.min)/(parametersThresholdSliderInput.max-parametersThresholdSliderInput.min)*100);parametersThresholdSliderInput.style.setProperty("--fill-size",e+"%")}function d(e){parametersIntervalInputValDefault=e,parametersIntervalInput.value=e,parametersIntervalSliderInput.value=e;var t=Math.ceil((e-parametersIntervalSliderInput.min)/(parametersIntervalSliderInput.max-parametersIntervalSliderInput.min)*100);parametersIntervalSliderInput.style.setProperty("--fill-size",t+"%"),u(getTranslationBabel("Scene transitions with frames interval")+` ${e} `+getTranslationBabel("and the first and last frame will be received."),!1),i.classList.remove("hidden")}parametersThresholdInput=o.querySelector(".threshold-input"),parametersThresholdSliderInput=o.querySelector(".threshold-slider"),parametersIntervalSliderInput=o.querySelector(".interval-slider"),parametersIntervalInput=o.querySelector(".interval-input"),parametersThresholdInput.addEventListener("change",function(){s(this.value)}),parametersThresholdSliderInput.addEventListener("input",function(){s(this.value)}),parametersIntervalInput.addEventListener("change",function(){d(this.value)}),parametersIntervalSliderInput.addEventListener("input",function(){d(this.value)}),e&&d(e);const c=async()=>{let e;e=(["jpg","jpeg","png","gif","bmp"].includes(n.toLowerCase())?generateImageFilename:["mp4","avi","mov","wmv","mkv"].includes(n.toLowerCase())?generateVideoFilename:["wav","mp3"].includes(n.toLowerCase())?generateAudioFilename:generateUUID)(),"string"==typeof a&&(a=await urlToBlob(a)),uploadChunkFile(a,e);var t={method:moduleScenedetectName,filename:e,interval:parametersIntervalSliderInput.value,threshold:parametersThresholdSliderInput.value};await fetch("/submit-cpu-task",{method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{if(200===e.status){const t=e.id;setTimeout(()=>{(async e=>{const a=setInterval(async()=>{await fetch(`/query-cpu-task/${e}`,{method:"GET",headers:{"Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{if(e.status===200){clearInterval(a);if(!e.response){u(getTranslationBabel("Oops! Something went wrong. Please try again."),true);return}const t=e.response.scenes;if(Array.isArray(t)&&t.length!==0){createModalControlRestyle(t);o.remove()}else u(getTranslationBabel("Wow! Somthing went wrong. Because of scenes can not be empty. Please try another file."),false)}else if(e.status===300){clearInterval(a);u(e.response.message,true)}else if(e.status===404){clearInterval(a);u(e.response.message,true)}}).catch(e=>{console.error("An error occurred:",error);clearInterval(a);u(getTranslationBabel("Oops! An unexpected error occurred. Please try again."),true)})},3e3)})(t)},1e3)}else loaderModalWarn("Something wrong..."+e.message)}).catch(e=>{loaderModalError(getTranslationBabel("Something wrong...During create task."))})};function u(e,t=!1){i.classList.add("hidden"),l.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" stroke="#fff" fill="#fff" class="shrink-0"><g clip-path="url(#a)"><path fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-opacity="0.6" stroke-width="1.5" d="M10 6.666V10m0 3.333h.008M18.333 10a8.333 8.333 0 1 0-16.667 0 8.333 8.333 0 0 0 16.667 0Z"></path></g><defs><clipPath id="a"><path stroke="none" d="M0 0h20v20H0z"></path></clipPath></defs></svg><span>${e}</span>`,!1===t?(l.classList.remove("bg-dark-background"),l.classList.add("bg-accent-primary")):(l.classList.remove("bg-dark-background"),l.classList.add("bg-danger-primary"))}r.onclick=async function(){i.innerHTML="";var e=document.createElement("div"),t=(e.classList.add("flex","items-center","gap-2","p-2.5","relative","w-full","h-10","bg-dark-elements","rounded-[.625rem]","overflow-hidden"),document.createElement("div")),a=(t.classList.add("absolute","w-full","h-full","left-0","top-0","bg-gradient-to-r","from-[rgba(255,237,210,0.20)]","to-accent-primary","opacity-10"),t.style.background="linear-gradient(to right, rgba(255, 237, 210, 0.2), rgb(255, 237, 210))",document.createElement("p"));a.classList.add("text-m-mobile","md:text-m","grow"),a.textContent=getTranslationBabel("Scanning..."),(scanLoadingDivBackground=document.createElement("div")).classList.add("absolute","h-full","w-full","left-0","top-0","animate-loadingStripe"),scanLoadingDivBackground.style.background="repeating-linear-gradient(-45deg, rgba(255, 255, 255, 0), rgba(255, 255, 255, 0) 16px, rgba(0, 0, 0, 0.08) 16px, rgba(0, 0, 0, 0.08) 32px) 0% 0% / 200% 200%",e.appendChild(t),e.innerHTML+='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" fill="none" class="animate-loadingRing mx-auto stroke-accent-primary"><path d="M17.5 10C17.5 14.1421 14.1421 17.5 10 17.5C5.85786 17.5 2.5 14.1421 2.5 10C2.5 5.85786 5.85786 2.5 10 2.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>',e.appendChild(a),e.appendChild(scanLoadingDivBackground),i.appendChild(e),await c()},console.log(a),document.body.appendChild(t)}async function createGenerationParametersControlRestyle(r,t,e=null,a=null,n=null,o=null){"ontouchstart"in window||navigator.msMaxTouchPoints;const i=document.querySelector(".modal-control-restyle-parameters-template").content.cloneNode(!0).querySelector(".modal-root"),s=i.querySelector(".modal-canvas"),l=i.querySelector(".modal-load-element");l.setAttribute("data-index",r);var R=i.querySelector(".number-frames"),N=i.querySelector(".download"),j=i.querySelector(".upload");const d=i.querySelector(".modal-positive-prompt"),c=i.querySelector(".modal-negative-prompt");var H=i.querySelector(".inspire-button");const u=i.querySelector(".modal-restyle-btn"),m=i.querySelectorAll(".modal-submit-btn"),h=i.querySelector(".modal-back-btn"),g=i.querySelector(".brush-wheel");var z=i.querySelector(".clear-brush"),O=i.querySelector(".delete-button");const p=i.querySelector(".zoom-button"),f=i.querySelectorAll(".modal-seed"),v=i.querySelectorAll(".modal-strength");var W=i.querySelectorAll(".modal-strength-slider");const y=i.querySelectorAll(".modal-scale");var V=i.querySelectorAll(".modal-scale-slider");const b=i.querySelectorAll(".modal-control-strength"),w=i.querySelectorAll(".modal-control-strength-slider"),M=i.querySelectorAll(".modal-blur-factor"),S=i.querySelectorAll(".modal-blur-factor-slider"),k=document.createElement("canvas");function x(e){var t=e.style.transform,a=e.style.transition;k.style.transform=t,k.style.transition=a,requestAnimationFrame(()=>x(e))}k.classList.add("w-auto","max-w-full","absolute","h-full","z-[1]","opacity-0","group-hover:opacity-60","transition-opacity","full-opacity-on-touchscreen");var G=new Zooming;p.onclick=function(){k.classList.contains("hidden")?k.classList.remove("hidden"):k.classList.add("hidden"),this.classList.contains("bg-dark-elements")?(this.classList.add("hover:bg-accent-hover","text-dark-background","bg-accent-primary"),this.classList.remove("hover:bg-dark-elements-hover","text-light-primary","bg-dark-elements","!bg-dark-pop-up")):(this.classList.add("hover:bg-dark-elements-hover","text-light-primary","bg-dark-elements","!bg-dark-pop-up"),this.classList.remove("hover:bg-accent-hover","text-dark-background","bg-accent-primary"))};const U=Math.floor(1000001*Math.random());if(f.forEach(e=>{e.value=U}),e&&e instanceof HTMLImageElement){const F=e.cloneNode(!0);F.classList.add("w-auto","max-w-full","object-contain","h-full"),F.setAttribute("default-src",F.src),o?F.setAttribute("data-index",o):F.setAttribute("data-index",r),s.appendChild(F),F.onload=()=>{k.width=F.width,k.height=F.height},handleZoomClick(F),G.listen(F),x(F)}else{if(!a||!n)return null;if(!["jpg","jpeg","png","gif","bmp"].includes(n.toLowerCase()))return console.log("The format file is neither an image format."),null;{const A=new Image;A.src=a,A.setAttribute("default-src",a),o?A.setAttribute("data-index",o):A.setAttribute("data-index",r),A.classList.add("w-auto","max-w-full","object-contain","h-full"),s.appendChild(A),A.onload=()=>{k.width=A.width,k.height=A.height},handleZoomClick(A),G.listen(A),x(A)}}function $(){var e,t,a=[[255,77,0,100],[229,44,150,100],[200,237,210,100],[153,210,23,100],[0,143,255,100],[255,206,0,100]],n=a.length;return e=0,t=n,e=Math.ceil(e),t=Math.floor(t),a[(Math.floor(Math.random()*(t-e+1))+e)%n]}s.appendChild(k);const C=k.getContext("2d",{willReadFrequently:!0});let L=!1,D=!1,T=$(),P=(g.style.color=`rgb(${T})`,25);const B=document.createElement("div");function E(e){var t,a,n;L&&(t=k.getBoundingClientRect(),n=k.width/t.width,a=k.height/t.height,n=(e.clientX-t.left)*n,e=(e.clientY-t.top)*a,C.lineWidth=P,C.lineCap="round",C.strokeStyle=`rgb(${T})`,C.lineTo(n,e),C.stroke(),C.beginPath(),C.moveTo(n,e))}function J(e){var t,a;D&&(t=k.getBoundingClientRect(),a=e.clientX-t.left,e=e.clientY-t.top,C.globalCompositeOperation="destination-out",C.beginPath(),C.arc(a,e,P/2,0,2*Math.PI),C.fill(),C.globalCompositeOperation="source-over")}B.classList.add("mouse-indicator","z-[2]"),s.appendChild(B),k.addEventListener("mousedown",e=>{0===e.button?(L=!0,D=!1,E(e)):2===e.button&&(D=!0,L=!1,J(e))}),k.addEventListener("mouseup",()=>{L=!1,D=!1,C.beginPath()}),k.addEventListener("mousemove",e=>{var t,a,n,o,l,r;t=e,a=s.offsetWidth,n=s.offsetHeight,o=k.getBoundingClientRect(),l=k.width/o.width,r=k.height/o.height,l=(t.clientX-o.left)*l,t=(t.clientY-o.top)*r,o=P,r=(a-k.width)/2+l-o/2,a=(n-k.height)/2+t-o/2,B.style.display="block",B.style.width=P+"px",B.style.height=P+"px",B.style.left=r+"px",B.style.top=a+"px",B.style.border="1px solid white",E(e),J(e)}),k.addEventListener("mouseleave",()=>{B.style.display="none"}),k.addEventListener("contextmenu",e=>{e.preventDefault()}),k.addEventListener("touchstart",e=>{e.preventDefault();e=e.touches[0];L=!0,E(e)}),k.addEventListener("touchend",()=>{L=!1,D=!1,C.beginPath()}),k.addEventListener("touchmove",e=>{E(e.touches[0])}),window.addEventListener("resize",()=>{var e=i.querySelector("img");e&&(k.style.width=e.width,k.style.height=e.height)});let I={seed:"",strength:.75,scale:7.5,controlStrength:.7,blurFactor:10,positivePrompt:"",negativePrompt:"",sourceCanvas:null};function Z(e,t,a){const n=Math.max(Math.min(a.value,a.max),a.min),o=Math.ceil((n-a.min)/(a.max-a.min)*100);e.forEach(e=>{e.value=n,e.style.setProperty("--fill-size",o+"%")}),t.forEach(e=>{e.value=n})}function q(t,a){t.forEach(e=>{e.addEventListener("change",function(){Z(a,t,this)})}),a.forEach(e=>{e.addEventListener("input",function(){Z(a,t,this)})})}function _(t=!0){u.disabled=t,h.disabled=t,m.forEach(e=>{e.disabled=t})}function K(e=null,t=!1,a=!1){if(_(t),u.disabled=a,e){t=i.querySelector("img");const n=C.getImageData(0,0,k.width,k.height);t.src=e,t.onload=function(){C.putImageData(n,0,0)}}}return R.textContent=r+1+" / "+(t+1),f.forEach(e=>{e.addEventListener("change",function(e){const t=e.target.value;f.forEach(e=>{e.value=t})})}),q(v,W),q(y,V),q(b,w),q(M,S),H.onclick=function(){d.value=getRandomPrompt()},j.onclick=async function(){var e=document.createElement("input");e.type="file",e.accept=".png, .jpg, .jpeg",e.click(),e.onchange=function(e){var t,e=e.target.files[0];e&&((t=new FileReader).onload=function(e){const t=i.querySelector("img");t&&(t.src=e.target.result,t.onload=()=>{k.width=t.width,k.height=t.height})},t.readAsDataURL(e))}},u.onclick=async function(){var e;0<d.value.length?(d.parentElement.classList.remove("border-danger-primary","border"),loaderModalBusy(getTranslationBabel("Inpainting... Buttons are locked until finished. Tap on the screen to view details."),r),l.classList.remove("hidden"),(e=i.querySelector("img"))&&(I.sourceImg=e.src),I.positivePrompt=d.value,I.negativePrompt=c.value,I.seed=f[0].value,I.strength=v[0].value,I.scale=y[0].value,I.controlStrength=b[0].value,I.blurFactor=M[0].value,I.sourceCanvas=await saveCanvasAsJPEG(k,e.naturalWidth,e.naturalHeight),_(!0),sendModuleData.moduleParameters.ControlDiffusionParameters.splice(r,1),sendModuleData.moduleParameters.ControlDiffusionParameters.push(I),await fetchSendModuleDataInpaint(r,K)):d.parentElement.classList.add("border-danger-primary","border")},O.onclick=function(){const e=i.querySelector("img");if(e){var t=e.getAttribute("default-src");if(t){const a=C.getImageData(0,0,k.width,k.height);e.src=t,e.onload=function(){C.putImageData(a,0,0),k.width===e.width&&k.height===e.height||(k.width=e.width,k.height=e.height)}}}},z.onclick=function(){var e=i.querySelector("img");e&&(k.width=e.width,k.height=e.height,C.clearRect(0,0,k.width,k.height))},g.addEventListener("contextmenu",function(e){e.preventDefault(),2===e.button&&(T=$(),g.style.color=`rgb(${T})`)}),g.addEventListener("mousedown",function(e){k.classList.remove("hidden"),0===e.button&&(1.4<.1+(e=parseFloat(window.getComputedStyle(this).fontSize)/16)?(this.style.fontSize="0.5rem",P=5):(this.style.fontSize=.1+e+"rem",P+=5)),p.classList.contains("bg-accent-primary")&&(p.classList.add("hover:bg-dark-elements-hover","text-light-primary","bg-dark-elements","!bg-dark-pop-up"),p.classList.remove("hover:bg-accent-hover","text-dark-background","bg-accent-primary"))}),0===r&&(h.disabled=!0),N.onclick=function(){var e,t=i.querySelector("img");t&&(t=t.src,(e=document.createElement("a")).href=t,e.download=generateImageFilename(),document.body.appendChild(e),e.click(),document.body.removeChild(e))},h.onclick=function(){var e,t,a,n,o=document.querySelector(".modal-root-parameters").childNodes,l=r-1;(0<l||0==l)&&(sendModuleData.moduleParameters.ControlDiffusionParameters.splice(r,1),e=o[l].querySelector("canvas"),t=k.getContext("2d"),a=e.getContext("2d"),n=t.getImageData(0,0,k.width,k.height),e.width=k.width,e.height=k.height,a.putImageData(n,0,0),t.clearRect(0,0,k.width,k.height),o[l].classList.remove("hidden"),i.classList.add("hidden"))},m.forEach(e=>{r===t&&"Continue"===e.textContent.trim()&&(e.textContent="Submit"),e.onclick=async function(){var e,t,a,n=document.querySelector(".modal-root-parameters").childNodes,o=r+1,l=i.querySelector("img");l&&(I.sourceImg=l.src),I.positivePrompt=d.value,I.negativePrompt=c.value,I.seed=f[0].value,I.strength=v[0].value,I.scale=y[0].value,I.controlStrength=b[0].value,I.blurFactor=M[0].value,sendModuleData.moduleParameters.ControlDiffusionParameters.splice(r,1),sendModuleData.moduleParameters.ControlDiffusionParameters.push(I),n.length>o?(l=n[o].querySelector("canvas"),e=k.getContext("2d"),t=l.getContext("2d"),a=e.getImageData(0,0,k.width,k.height),l.width=k.width,l.height=k.height,t.putImageData(a,0,0),e.clearRect(0,0,k.width,k.height),n[o].querySelector(".modal-positive-prompt").value=d.value,n[o].querySelector(".modal-negative-prompt").value=c.value,n[o].querySelectorAll(".modal-seed").forEach(e=>{e.value=f[0].value}),n[o].querySelectorAll(".modal-strength").forEach(e=>{e.value=v[0].value}),n[o].querySelectorAll(".modal-strength-slider").forEach(e=>{e.value=v[0].value,elementFillSize=Math.ceil((e.value-e.min)/(e.max-e.min)*100),e.style.setProperty("--fill-size",elementFillSize+"%")}),n[o].querySelectorAll(".modal-scale").forEach(e=>{e.value=y[0].value}),n[o].querySelectorAll(".modal-scale-slider").forEach(e=>{e.value=y[0].value,elementFillSize=Math.ceil((e.value-e.min)/(e.max-e.min)*100),e.style.setProperty("--fill-size",elementFillSize+"%")}),n[o].querySelectorAll(".modal-control-strength").forEach(e=>{e.value=b[0].value}),n[o].querySelectorAll(".modal-control-strength-slider").forEach(e=>{e.value=w[0].value,elementFillSize=Math.ceil((e.value-e.min)/(e.max-e.min)*100),e.style.setProperty("--fill-size",elementFillSize+"%")}),n[o].querySelectorAll(".modal-blur-factor").forEach(e=>{e.value=M[0].value}),n[o].querySelectorAll(".modal-blur-factor-slider").forEach(e=>{e.value=S[0].value,elementFillSize=Math.ceil((e.value-e.min)/(e.max-e.min)*100),e.style.setProperty("--fill-size",elementFillSize+"%")}),n[o].classList.remove("hidden"),i.classList.add("hidden")):(await fetchSendModuleDataControlRestyling(),document.querySelector(".modal-restyle-close-button").click())}}),i}async function createModalControlRestyle(o){var e=document.querySelector(".modal-control-restyle-submit-template").content.cloneNode(!0);const l=e.querySelector(".modal-root").querySelector(".modal-root-parameters");sendModuleData.moduleParameters.ControlDiffusionParameters=[],o.forEach(async(e,t)=>{var a,n=e.file,e=e.frame;n&&(a=1<(a=(a=n).split(".")).length?a.pop():"",(n=await createGenerationParametersControlRestyle(t,o.length-1,null,n,a,e))instanceof HTMLDivElement)&&(0!==t&&n.classList.add("hidden"),l.appendChild(n))}),document.body.appendChild(e)}async function fetchSendModuleDataInpaint(l,r=null){(async()=>{var e=sendModuleData.moduleParameters.ControlDiffusionParameters[l];let t=e.sourceImg;var a=e.sourceCanvas,n=generateImageFilename();"string"==typeof t&&(t=await urlToBlob(t)),uploadChunkFile(t,n),e.sourceImg=null,e.positivePrompt=await translateText(e.positivePrompt,"en","auto"),e.negativePrompt=await translateText(e.negativePrompt,"en","auto");const o={method:moduleInpaintName,filename:n,canvasFileName:a,sdModel:sendModuleData.moduleParameters.sdModel,eta:0,diffusionParameters:e};console.log(JSON.stringify(o,null,4)),await fetch("/submit-cpu-task",{method:"POST",body:JSON.stringify(o),headers:{"Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{if(200===e.status){const t=e.id;setTimeout(()=>{(async(a,e,n=null)=>{const o=setInterval(async()=>{await fetch(`/query-cpu-task/${e}`,{method:"GET",headers:{"Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{if(e.status===200){clearInterval(o);if(!e.response){loaderModalWarn(getTranslationBabel("Oops! Something went wrong. Please click submit again after some time. Tap on the screen to view details."),a);if(n&&typeof n==="function")n(null,true);return}const t=e.response.filename;if(n&&typeof n==="function")n(t);loaderModalHidden(a)}else if(e.status===300){loaderModalWarn(e.response.message,a);if(n&&typeof n==="function")n(null,true,true)}else if(e.status===404){loaderModalWarn(e.response.message,a);if(n&&typeof n==="function")n(null,true,true)}else loaderModalBusy(`${e.progress_message} ${e.progress}%`,a)}).catch(e=>{clearInterval(o);loaderModalError(getTranslationBabel("Oops! An unexpected error occurred. Tap on the screen to view details."),a);if(n&&typeof n==="function")n(null,true,true)})},3e3)})(l,t,r)},1e3)}else loaderModalWarn("Something wrong..."+e.message,l)}).catch(e=>{loaderModalError("Something wrong...During create task. Tap on the screen to view details.",l)})})()}async function saveCanvasAsJPEG(e,t,a,n=.8){var o=generateImageFilename(),l=!e.getContext("2d").getImageData(0,0,e.width,e.height).data.some(e=>0!==e),r=document.createElement("canvas"),i=(r.width=t,r.height=a,r.getContext("2d"));l?(i.fillStyle="white",i.fillRect(0,0,t,a),console.log("Canvas is empty. Saving a black image.")):i.drawImage(e,0,0,t,a);let s=r.toDataURL("image/jpeg",n);return(s="string"==typeof s?await urlToBlob(s):s)&&(console.log("download file"),await uploadChunkFile(s,o)),o}function setLiteSetting(){var e=document.querySelector(".system-processor")||null;e&&e.remove();const t=getTranslationBabel("diffuser");e=document.querySelector("#settings");e.href="",e.onclick=async function(){event.preventDefault(),createModalLiteSetting(t,"DIFFUSER",1080)}}function openDownloadModelsNotificationModal(){var e=document.querySelector(".modal-download-models-notification-template").content.cloneNode(!0);e.querySelectorAll(".restyling").forEach(e=>{e.classList.remove("hidden")}),document.body.appendChild(e)}setLiteSetting(),downloadModels&&openDownloadModelsNotificationModal(),createFooterFile(callbacks,pageFileFormats);