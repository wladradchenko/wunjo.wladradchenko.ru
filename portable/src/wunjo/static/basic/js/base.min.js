async function getHistory({is_existing:e=!0,period:o="month"}={}){var t=new Date;const n=t.getFullYear(),a=t.getMonth(),r=t.getDate(),s=e=>{if(!e?.date)return!1;var t=new Date(e.date);switch(o){case"day":return t.getFullYear()===n&&t.getMonth()===a&&t.getDate()===r;case"month":return t.getFullYear()===n&&t.getMonth()===a;case"all":return!0;default:throw new Error(`Invalid period: ${o}. Use 'day', 'month' or 'all'.`)}};try{var i=await fetch("/get-history",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({is_existing:e})});if(!i.ok)throw new Error("HTTP error! Status: "+i.status);const c=await i.json();var l=e?e=>e?.user===c.user_id&&s(e):s;return c.history.filter(l).sort((e,t)=>e.date&&t.date?new Date(t.date)-new Date(e.date):0)}catch(e){return console.error("Error while getting history:",e),[]}}async function countHistoryStats(e=24,t=24){var o=await getHistory({is_existing:!1,period:"month"}),n=new Date;const a=n.getMonth(),r=n.getFullYear(),s=new Date(n.getTime()-60*t*60*1e3),i=new Date(n.getTime()-60*e*60*1e3);let l={isNotFlagNumberHours:0,isNotFlagDateHours:new Date(Date.now()-9e7),isFlagNumberHours:0,isFlagDateHours:new Date(Date.now()-9e7),isFlagNumberMonth:0};return o.forEach(e=>{var t=new Date(e.date);e.flag?(t>=s&&(l.isFlagNumberHours++,!l.isFlagDateHours||t>l.isFlagDateHours)&&(l.isFlagDateHours=t),t.getMonth()===a&&t.getFullYear()===r&&l.isFlagNumberMonth++):(t>=i&&l.isNotFlagNumberHours++,(!l.isNotFlagDateHours||t>l.isNotFlagDateHours)&&(l.isNotFlagDateHours=t))}),{...l,isFlagDateHours:l.isFlagDateHours?l.isFlagDateHours.getTime():null,isNotFlagDateHours:l.isNotFlagDateHours?l.isNotFlagDateHours.getTime():null}}async function initSliderBar(){const e=document.querySelectorAll(".nav-menu-btn");document.querySelectorAll(".nav-dropdown-content");const s=new Map;async function r(e){if(s.has(e))return s.get(e);var o,t,n=e.split(".").pop();let a={};"mp4"===n?a=(t=e,await new Promise(o=>{const n=document.createElement("video");n.crossOrigin="anonymous",n.muted=!0,n.preload="metadata",n.addEventListener("loadedmetadata",function(){n.currentTime=.1}),n.addEventListener("seeked",function(){var e=document.createElement("canvas");e.width=n.videoWidth,e.height=n.videoHeight;e.getContext("2d").drawImage(n,0,0,e.width,e.height);var t=e.width/e.height;o({thumbnail:e.toDataURL("image/jpeg"),ratio:t}),n.remove()}),n.src=t})):"jpg"===n&&(a=(o=e,await new Promise(t=>{var e=new Image;e.onload=function(){var e=this.naturalWidth/this.naturalHeight;t({thumbnail:o,ratio:e})},e.onerror=()=>t({thumbnail:"",ratio:16/9}),e.src=o})));var n=a.thumbnail,r=a.ratio;return s.set(e,{thumbnail:n,ratio:r}),{thumbnail:n,ratio:r}}e.forEach(async function(n){n.addEventListener("click",async function(){var e=await getHistory({is_existing:!0,period:"day"}),t=this.nextElementSibling,o=(t.classList.toggle("hidden"),this.querySelector("svg"));if(o&&o.classList.toggle("rotate-180"),n.classList.contains("nav-history")){const a=t.querySelector("ul");e.length&&(a.innerHTML="",e.forEach(e=>{const t=e.path.split(".").pop(),o=e.url.split("/").pop();const n=new ButtonNav({format:t,method:e.method.replace(/_/g," ").replace(/^\w/,e=>e.toUpperCase()),date:formatDateTime(e.date)});"mp4"!==t&&"jpg"!==t||(n.container.addEventListener("mouseenter",()=>{e.url&&r(e.url).then(({thumbnail:e,ratio:t})=>{n.preview.style.setProperty("--preview-ratio",t),n.preview.style.backgroundImage=`url(${e})`}).catch(()=>{}),n.preview.style.opacity="1",n.preview.style.visibility="visible"}),n.container.addEventListener("mousemove",e=>{n.preview.style.top=e.clientY-2*n.container.offsetHeight+"px"}),n.container.addEventListener("mouseleave",()=>{n.preview.style.opacity="0",n.preview.style.visibility="hidden"})),n.container.onclick=()=>{"mp4"===t?createModalVideo(e.url,{name:o,created:e.date},null):"jpg"===t?createModalImage(e.url,{name:o,created:e.date},null):"wav"===t&&createModalAudio(e.url,{name:o,created:e.date},null)},a.append(n.container)}))}})}),window.addEventListener("click",function(n){e.forEach(function(e){var t,o=e.nextElementSibling;e.contains(n.target)||o.contains(n.target)||(o.classList.add("hidden"),(t=e.querySelector("svg"))&&t.classList.remove("rotate-180"),e.classList.contains("nav-history")&&o.querySelector("ul"))})})}function closePopup(e){e.closest(".console-popup").classList.add("hidden")}function updateConsoleLog(){return new Promise((o,t)=>{processingTaskInBackend().then(()=>{fetch("/console-log",{method:"GET",headers:{"Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{var e=e.reverse().map(e=>e.replace("\r","").trimEnd()).filter(e=>""!==e.trim()),t=e.join("\n");0<e.length&&e.slice(0,2).join("\n");o(t)}).catch(e=>{console.error("Log field deleted, message from setInterval:",e),t(e)})}).catch(e=>{console.error("Error processing task in backend:",e),t(e)})})}function frontendConsoleLogToBackendPrint(e){fetch("/console-log-print",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({print:e})}).then(e=>e.json()).then(e=>{200===e.status?(console.log("Successfully sent print message to backend."),updateConsoleLog()):console.error("Failed to send print message to backend.")}).catch(e=>{console.error("An error occurred:",e)})}async function processingTaskInBackend(){fetch("/synthesize-process").then(e=>e.json()).then(t=>{document.querySelector(".notification-title").title!==t.message&&(document.querySelectorAll(".notification").forEach(e=>{e.title=t.message}),toggleLogNotificationElements(t.status))}).catch(e=>{console.error(e)})}function toggleLogNotificationElements(e){let t="Wunjo",o;switch(e){case 100:t=getTranslationBabel("Processing"),o="text-dim-gray";break;case 200:break;case 300:t=getTranslationBabel("Check Warning"),o="text-warn-primary";break;case 404:t=getTranslationBabel("View Error"),o="text-danger-primary"}e=document.querySelector(".notification-title");e.textContent=t,e.classList.remove("text-dim-gray","text-accent-primary","text-danger-primary","text-warn-primary"),o&&e.classList.add(o)}function handleDownloadLogConsole(){updateConsoleLog().then(e=>{var t,o;e&&(t="console_log_"+(new Date).toISOString()+".log",e=new Blob([e],{type:"text/plain"}),(o=document.createElement("a")).href=URL.createObjectURL(e),o.download=t,document.body.appendChild(o),o.click(),document.body.removeChild(o))}).catch(e=>{console.error("Error downloading log:",e)})}function openNotificationMessageModal(e=null){var t=document.querySelector(".modal-log-notice-template").content.cloneNode(!0);const o=t.querySelector(".modal-root");function n(){updateConsoleLog().then(e=>{var t;e&&((t=o.querySelector(".modal-root-textarea-log")).placeholder=e,t.scrollHeight<=parseFloat(getComputedStyle(t).maxHeight)?t.style.height=t.scrollHeight+"px":t.style.height=parseFloat(getComputedStyle(t).maxHeight)+"px")}).catch(e=>{console.error("Error updating log textarea:",e)})}e&&(o.querySelector(".modal-root-log-description").textContent=e.title),o.querySelector(".download-log").addEventListener("click",()=>{handleDownloadLogConsole()}),o.querySelector(".close-modal-log").addEventListener("click",()=>{toggleLogNotificationElements(200)}),n();const a=setInterval(n,1e3);o.querySelector(".close-modal-log").addEventListener("click",()=>{clearInterval(a)}),document.body.appendChild(t)}function initNotification(){document.querySelectorAll(".notification").forEach(e=>{e.addEventListener("click",()=>{openNotificationMessageModal(e)})})}function closeModal(e){e.closest(".modal-root").remove()}function uploadArrayBuffer(e,t="blob",o){var n=new FormData,e=new Blob([e]);n.append("file",e,t),fetch("/upload-tmp",{method:"POST",body:n}).then(e=>{e.ok?(console.log("Chunk uploaded successfully"),o&&o()):console.error("Upload failed")}).catch(e=>{console.error("Error:",e)})}function uploadChunkFile(n,a="blob",r){const s=n.size;let i=0;!function t(){var e=n.slice(i,i+10485760),o=new FormData;o.append("file",e,a),fetch("/upload-tmp",{method:"POST",body:o}).then(e=>{e.ok?(i+=10485760)<s?t():(console.log("File uploaded successfully"),r&&r()):console.error("Upload failed")}).catch(e=>{console.error("Error:",e)})}()}function generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}function generateImageFilename(){return generateUUID()+".jpg"}function generateVideoFilename(){return generateUUID()+".mp4"}function generateAudioFilename(){return generateUUID()+".wav"}async function getLimitResolution(e){try{var t=await fetch("/get-resolution/"+e,{method:"GET",headers:{"Content-Type":"application/json"}});return t.ok?(await t.json()).max_content_size:(console.error("Error fetching data:",t.statusText),null)}catch(e){return console.error("Error:",e),null}}function setLimitResolution(e,t,o){var n=t/o;let a=t,r=o;return e<Math.max(t,o)&&(1<n?(a=e,r=Math.ceil(a/n)):(r=e,a=Math.ceil(r*n))),{newWidth:a,newHeight:r}}async function getAccess(){try{var e,t=await fetch("/get-access",{method:"GET",headers:{"Content-Type":"application/json"}});return t.ok?{hasFullAccess:(e=await t.json()).full_access,useCpu:e.use_cpu,session:e.session}:(console.error("Error fetching data:",t.statusText),null)}catch(e){return console.error("Error:",e),null}}async function moduleTileAnimation(){document.querySelectorAll(".module-tile").forEach(e=>{e.classList.contains("access-gpu-grayscale")||setTimeout(()=>{e.classList.remove("grayscale-100"),e.classList.add("grayscale-0")},0)})}async function setAccess(){const t=await getAccess();t?(document.querySelectorAll(".access-admin").forEach(e=>{!1===t.access&&e.remove()}),document.querySelectorAll(".access-gpu").forEach(e=>{(!1===t.useCpu||null===t.session)&&e.classList.remove("access-gpu")}),document.querySelectorAll(".access-gpu-grayscale").forEach(e=>{(!1===t.useCpu||null===t.session)&&setTimeout(()=>{e.classList.remove("grayscale-100"),e.classList.add("grayscale-0")},0)})):console.error("Failed to fetch access data.")}function indicateUpdateVersion(){var e=currentVersionDiv.getAttribute("vers");0<function(e,t){var o=e.split(".").map(Number),n=t.split(".").map(Number);for(let e=0;e<Math.max(o.length,n.length);e++){var a=o[e]||0,r=n[e]||0;if(a<r)return-1;if(r<a)return 1}return 0}(JSON.parse(serverVersionData).version||e,e)?currentVersionDiv.innerHTML=`<div class="cursor-pointer rounded-md flex items-center justify-center transition-all font-normal disabled:cursor-not-allowed px-1.5 gap-1.5 py-1.5 h-max self-center !pr-3 text-accent-primary group duration-500"><svg class="group-hover:fill-accent" width="23px" height="23px" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" stroke-width="3" stroke="#000000" fill="none" style="stroke: rgb(200 237 210);"><path d="M30,52.16c.81-2.07,7.06-17,19.76-19.86a.09.09,0,0,0,0-.18c-2.14-.86-15.22-6.57-19.38-20.26a.09.09,0,0,0-.18,0c-.51,2.27-3.94,14.43-20,20a.1.1,0,0,0,0,.19c2.24.38,13.48,3.14,19.62,20.15A.1.1,0,0,0,30,52.16Z"></path><path d="M48.79,25.08c.29-.74,2.52-6.07,7.06-7.09a0,0,0,0,0,0-.07c-.76-.3-5.43-2.34-6.92-7.23a0,0,0,0,0-.07,0c-.18.82-1.4,5.16-7.14,7.13a0,0,0,0,0,0,.07c.8.14,4.81,1.12,7,7.2A0,0,0,0,0,48.79,25.08Z"></path></svg>${getTranslationBabel("Update")}</div>`:currentVersionDiv.innerHTML="v"+e}updateConsoleLog(),consoleBackendLogSetInterval=setInterval(updateConsoleLog,1e3),indicateUpdateVersion();