name: CI/CD Pipeline Package Windows

on:
  workflow_dispatch:
    inputs:
      processor:
        description: 'Choose the processor type (gpu, cpu, zluda)'
        required: false
        default: 'gpu'
      output-format:
        description: 'Choose the output format (msi or zip)'
        required: true
        default: 'msi'
      sign-file:
        description: "Sign the file (yes or no)"
        required: false
        default: 'no'
      debug:
        description: "Debug (yes or no)"
        required: false
        default: 'no'

env:
  FORCE_COLOR: "1"
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  SSH_HOST: ${{ secrets.SSH_HOST }}
  SSH_PORT: ${{ secrets.SSH_PORT || 22 }}
  SSH_USER: ${{ secrets.SSH_USER }}
  SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
  PROCESSOR: ${{ github.event.inputs.processor || 'gpu' }}  # Default to 'gpu' if not provided
  OUTPUT_FORMAT: ${{ github.event.inputs.output-format || 'msi' }}

jobs:
  build-and-deploy:
    runs-on: ${{ matrix.runs-on }}
    strategy:
      matrix:
        target: [windows]
        include:
          - target: "windows"
            output-format: "msi"
            pre-command: |
              choco install visualstudio2022buildtools --confirm
              choco install visualstudio2022-workload-vctools --confirm
              choco install wixtoolset --version 4.0.5 --confirm
            runs-on: "windows-latest"
            python-version: "3.10"

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Set WIX_HOME and update PATH
        shell: pwsh
        run: |
          echo "WIX_HOME=C:\Program Files\WiX Toolset v4.0" >> $env:GITHUB_ENV
          echo "PATH=C:\Program Files\WiX Toolset v4.0\bin;$env:PATH" >> $env:GITHUB_ENV

      - name: (DEBUG) Checkout portable only
        if: ${{ github.event.inputs.debug == 'yes' }}
        uses: actions/checkout@v4
        with:
          repository: wladradchenko/pro.wunjo.wladradchenko.ru
          ssh-key: ${{ secrets.SSH_DEPLOY_KEY }}
          ssh-strict: true
          path: portable-repo
          sparse-checkout: portable
          ref: main

      - name: (DEBUG) Move portable folder
        if: ${{ github.event.inputs.debug == 'yes' }}
        shell: pwsh
        run: |
          if (Test-Path "portable") {
              Remove-Item -Recurse -Force "portable"
          } 

          Move-Item -Path "portable-repo/portable" -Destination "portable" -Force
          Remove-Item -Recurse -Force "portable-repo"

          Write-Host "Portable folder updated from repo"

      - name: Build electron browser
        working-directory: tools/js/browser
        shell: pwsh
        run: |
          npm install
          npx electron-builder --$env:TARGET portable

      - name: Copy browser files
        shell: pwsh
        run: |
          $sourceDir = "tools/js/browser/dist"
          $destDir = "portable/src/win"

          # Create the target directory if it doesn't exist
          if (-not (Test-Path $destDir)) {
            New-Item -ItemType Directory -Path $destDir -Force | Out-Null
          }

          $exeFile = Get-ChildItem -Path $sourceDir -Filter *.exe -File | Select-Object -First 1

          if ($exeFile) {
            Write-Host "Found EXE: $($exeFile.Name), copying it"
            Copy-Item -Path $exeFile.FullName -Destination (Join-Path $destDir "webgui.exe") -Force
          }
          elseif (Test-Path "$sourceDir/win-unpacked") {
            Write-Host "No single EXE found, copying win-unpacked contents"
            Get-ChildItem -Path "$sourceDir/win-unpacked" | ForEach-Object {
              Copy-Item -Path $_.FullName -Destination $destDir -Recurse -Force
            }
          }
          else {
            Write-Host "::error::No built files found in $sourceDir"
            exit 1
          }

          # Display a list of copied files for verification
          Write-Host "Copied files:"
          Get-ChildItem -Path $destDir | Select-Object Name

      - name: Select processor configuration
        working-directory: portable
        shell: pwsh
        run: |
          Write-Host "Using processor: $env:PROCESSOR"
          if (-not (Test-Path "pyproject_$env:PROCESSOR.toml")) {
            throw "File pyproject_$env:PROCESSOR.toml not found!"
          }
          Copy-Item "pyproject_$env:PROCESSOR.toml" -Destination "pyproject.toml"

      - name: Set up Python environment
        shell: pwsh
        run: |
          python -m venv venv --copies

          .\venv\Scripts\Activate.ps1
          
          python -m pip install -U --force-reinstall pip
          python -m pip install -U setuptools wheel
          python -m pip install briefcase insightface

          python --version
          python -m pip --version

      - name: Build application
        shell: pwsh
        run: |
          .\venv\Scripts\Activate.ps1

          cd portable
          python -m briefcase build $env:TARGET

          Get-ChildItem -Path .\build -Recurse | Select-Object FullName | Write-Host

      - name: Sign libcrypto-1_1.dll with SignPath
        if: ${{ github.event.inputs['sign-file'] == 'yes' }}
        uses: signpath/github-action-submit-signing-request@v2
        with:
          api-token: ${{ secrets.SIGN_PATH_TOKEN }}
          organization-id: "b01997fa-53cc-4ead-afd5-d225dccbc2c9"
          project-slug: 'wunjo.wladradchenko.ru'
          signing-policy-slug: 'test-signing'
          artifact-configuration-slug: 'initial'
          input-artifact-path: "portable/build/wunjo/windows/app/src/libcrypto-1_1.dll"
          output-artifact-path: "portable/build/wunjo/windows/app/src/signed_libcrypto-1_1.dll"
          wait-for-completion: true

      - name: Sign libssl-1_1.dll with SignPath
        if: ${{ github.event.inputs['sign-file'] == 'yes' }}
        uses: signpath/github-action-submit-signing-request@v2
        with:
          api-token: ${{ secrets.SIGN_PATH_TOKEN }}
          organization-id: "b01997fa-53cc-4ead-afd5-d225dccbc2c9"
          project-slug: 'wunjo.wladradchenko.ru'
          signing-policy-slug: 'test-signing'
          artifact-configuration-slug: 'initial'
          input-artifact-path: "portable/build/wunjo/windows/app/src/libssl-1_1.dll"
          output-artifact-path: "portable/build/wunjo/windows/app/src/signed_libssl-1_1.dll"
          wait-for-completion: true

      - name: Sign libffi-7.dll with SignPath
        if: ${{ github.event.inputs['sign-file'] == 'yes' }}
        uses: signpath/github-action-submit-signing-request@v2
        with:
          api-token: ${{ secrets.SIGN_PATH_TOKEN }}
          organization-id: "b01997fa-53cc-4ead-afd5-d225dccbc2c9"
          project-slug: 'wunjo.wladradchenko.ru'
          signing-policy-slug: 'test-signing'
          artifact-configuration-slug: 'initial'
          input-artifact-path: "portable/build/wunjo/windows/app/src/libffi-7.dll"
          output-artifact-path: "portable/build/wunjo/windows/app/src/signed_libffi-7.dll"
          wait-for-completion: true

      - name: Sign vcruntime140.dll with SignPath
        if: ${{ github.event.inputs['sign-file'] == 'yes' }}
        uses: signpath/github-action-submit-signing-request@v2
        with:
          api-token: ${{ secrets.SIGN_PATH_TOKEN }}
          organization-id: "b01997fa-53cc-4ead-afd5-d225dccbc2c9"
          project-slug: 'wunjo.wladradchenko.ru'
          signing-policy-slug: 'test-signing'
          artifact-configuration-slug: 'initial'
          input-artifact-path: "portable/build/wunjo/windows/app/src/vcruntime140.dll"
          output-artifact-path: "portable/build/wunjo/windows/app/src/signed_vcruntime140.dll"
          wait-for-completion: true

      - name: Sign vcruntime140_1.dll with SignPath
        if: ${{ github.event.inputs['sign-file'] == 'yes' }}
        uses: signpath/github-action-submit-signing-request@v2
        with:
          api-token: ${{ secrets.SIGN_PATH_TOKEN }}
          organization-id: "b01997fa-53cc-4ead-afd5-d225dccbc2c9"
          project-slug: 'wunjo.wladradchenko.ru'
          signing-policy-slug: 'test-signing'
          artifact-configuration-slug: 'initial'
          input-artifact-path: "portable/build/wunjo/windows/app/src/vcruntime140_1.dll"
          output-artifact-path: "portable/build/wunjo/windows/app/src/signed_vcruntime140_1.dll"
          wait-for-completion: true

      - name: Sign Wunjo.exe with SignPath
        if: ${{ github.event.inputs['sign-file'] == 'yes' }}
        uses: signpath/github-action-submit-signing-request@v2
        with:
          api-token: ${{ secrets.SIGN_PATH_TOKEN }}
          organization-id: "b01997fa-53cc-4ead-afd5-d225dccbc2c9"
          project-slug: 'wunjo.wladradchenko.ru'
          signing-policy-slug: 'test-signing'
          artifact-configuration-slug: 'initial'
          input-artifact-path: "portable/build/wunjo/windows/app/src/Wunjo.exe"
          output-artifact-path: "portable/build/wunjo/windows/app/src/signed_Wunjo.exe"
          wait-for-completion: true

      - name: Sign webgui.exe with SignPath
        if: ${{ github.event.inputs['sign-file'] == 'yes' }}
        uses: signpath/github-action-submit-signing-request@v2
        with:
          api-token: ${{ secrets.SIGN_PATH_TOKEN }}
          organization-id: "b01997fa-53cc-4ead-afd5-d225dccbc2c9"
          project-slug: 'wunjo.wladradchenko.ru'
          signing-policy-slug: 'test-signing'
          artifact-configuration-slug: 'initial'
          input-artifact-path: "portable/build/wunjo/windows/app/src/app/win/webgui.exe"
          output-artifact-path: "portable/build/wunjo/windows/app/src/app/win/signed_webgui.exe"
          wait-for-completion: true

      - name: SignPath files
        shell: pwsh
        run: |
          if ('${{ github.event.inputs.sign-file }}' -eq 'yes') {

            $filesToSign = @(
              "portable/build/wunjo/windows/app/src/libcrypto-1_1.dll",
              "portable/build/wunjo/windows/app/src/libssl-1_1.dll",
              "portable/build/wunjo/windows/app/src/libffi-7.dll",
              "portable/build/wunjo/windows/app/src/vcruntime140.dll",
              "portable/build/wunjo/windows/app/src/vcruntime140_1.dll",
              "portable/build/wunjo/windows/app/src/Wunjo.exe",
              "portable/build/wunjo/windows/app/src/app/win/webgui.exe"
            )

            foreach ($file in $filesToSign) {
              if (Test-Path $file) {
                $fileInfo = Get-Item $file
                $sizeMB = [math]::Round($fileInfo.Length / 1MB, 2)
                Write-Host "File for signature: $file (Size: $sizeMB MB)"

                Write-Host "File for signature: $file"
                $dir = Split-Path $file -Parent
                $name = Split-Path $file -Leaf
                $signedPath = Join-Path $dir ("signed_" + $name)

                if (Test-Path $signedPath) {
                  Remove-Item -Path $file
                  Rename-Item -Path $signedPath -NewName $name
                  Write-Host "The file '$file' has been signed and replaced."
                } else {
                  Write-Error "Signing Error! The signed file '$file' was not created."
                  exit 1
                }
              } else {
                Write-Error "File '$file' not found!"
              }
            }
          }
          
          exit 1

      - name: Package application
        shell: pwsh
        run: |
          .\venv\Scripts\Activate.ps1
          cd portable

          python -m briefcase package $env:TARGET -p $env:OUTPUT_FORMAT --adhoc-sign --log

          $distFiles = Get-ChildItem -Path .\dist
          Write-Host "Created package files:"
          $distFiles | ForEach-Object { Write-Host $_.FullName }

      - name: Upload unsigned installer
        id: upload-unsigned-installer
        if: ${{ github.event.inputs['sign-file'] == 'yes' && github.event.inputs['debug'] == 'yes' && env.OUTPUT_FORMAT == 'msi' }}
        uses: actions/upload-artifact@v4
        with:
          name: unsigned installer
          path: |
            portable/dist/*.msi
          compression-level: 0

      - name: Sign installer with SignPath
        if: ${{ github.event.inputs['sign-file'] == 'yes' && github.event.inputs['debug'] == 'yes' && env.OUTPUT_FORMAT == 'msi' }}
        uses: signpath/github-action-submit-signing-request@v2
        with:
          api-token: ${{ secrets.SIGN_PATH_TOKEN }}
          organization-id: "b01997fa-53cc-4ead-afd5-d225dccbc2c9"
          project-slug: 'wunjo.wladradchenko.ru'
          signing-policy-slug: 'test-signing'
          artifact-configuration-slug: 'initial_msi'
          github-artifact-id: ${{ steps.upload-unsigned-installer.outputs.artifact-id }}
          wait-for-completion: true
          output-artifact-directory: 'installer'

      - name: Upload signed artifact
        if: ${{ github.event.inputs['sign-file'] == 'yes' && github.event.inputs['debug'] == 'yes' && env.OUTPUT_FORMAT == 'msi' }}
        uses: actions/upload-artifact@v5
        with:
          name: installer
          path: installer


      - name: Upload unsigned artifact
        if: ${{ github.event.inputs['sign-file'] == 'no' || github.event.inputs['debug'] == 'no' || env.OUTPUT_FORMAT == 'zip' }}
        uses: actions/upload-artifact@v5
        with:
          name: portable-dist
          path: "portable/dist/*.${{ env.OUTPUT_FORMAT }}"


      - name: Upload Log
        if: failure()
        uses: actions/upload-artifact@v5
        with:
          name: Log-Failure-${{ matrix.target }}
          path: logs/*